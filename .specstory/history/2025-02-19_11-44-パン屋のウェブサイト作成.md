<!-- Generated by SpecStory -->

# パン屋のウェブサイト作成 (2025-02-19 20:44:47)

_**User**_

パン屋さんのウェブサイトを作ってください@index.html 

---

_**Assistant**_

Free & free trial accounts can no longer use chat with premium models on Cursor Version 0.45 or less. Please upgrade to Pro or use Cursor Version 0.46 or later. Install Cursor at https://www.cursor.com/downloads or update from within the editor.

---

_**User**_

エラー修正して

/**
 * Zoomの録画メールをチェック（定期実行および手動実行用）
 */
function checkZoomEmails() {
  try {
    // メールチェックの前に、必要なタグが存在するか確認し、なければ作成
    ensureGmailLabelsExist();
    
    // Zoom送信元とメール件名を取得（デフォルト値を使用）
    const zoomSender = PROPERTIES.getProperty('ZOOM_SENDER') || 'no-reply@zoom.us';
    const zoomSubject = PROPERTIES.getProperty('ZOOM_SUBJECT') || 'クラウド レコーディング';
    
    // 「録画」タグ付きメールを検索
    const query = `label:${TAG_RECORDING} from:${zoomSender} subject:"${zoomSubject}"`;
    const threads = GmailApp.search(query, 0, 10); // 最新10件まで処理
    
    // 手動実行の場合、結果を表示
    const isManualRun = ScriptApp.getTriggerId() === null;
    if (isManualRun && threads.length === 0) {
      SpreadsheetApp.getUi().alert('メールチェック', '新しい録画メールはありません。', SpreadsheetApp.getUi().ButtonSet.OK);
      return;
    }
    
    console.log(`${threads.length}件の録画メールを処理します`);
    let processedCount = 0;
    
    for (const thread of threads) {
      const messages = thread.getMessages();
      
      for (const message of messages) {
        // 処理済みかどうかをチェック（タグが変更されている可能性があるため）
        if (isMessageProcessed(message)) {
          console.log(`メールID: ${message.getId()} は既に処理済みです`);
          continue;
        }
        
        // メールからデータを抽出
        const recordingData = extractRecordingData(message);
        
        if (recordingData) {
          // スプレッドシートに情報を記録
          addRecordingToSheet(recordingData);
          
          // Discord通知を送信
          notifyEditorsDiscord(recordingData);
          
          // メールのタグを変更
          changeMessageTag(message);
          
          // 処理履歴に記録
          logToHistory(
            message.getSubject(),
            "処理成功",
            `URL: ${recordingData.url}, パスワード: ${recordingData.password}`
          );
          
          processedCount++;
          console.log(`メールID: ${message.getId()} の処理が完了しました`);
        } else {
          // 処理履歴に失敗を記録
          logToHistory(
            message.getSubject(),
            "処理失敗",
            "データの抽出に失敗しました"
          );
          
          console.log(`メールID: ${message.getId()} からデータを抽出できませんでした`);
        }
      }
    }
    
    // 手動実行の場合、結果を表示
    if (isManualRun) {
      SpreadsheetApp.getUi().alert(
        'メールチェック', 
        `${processedCount}件の新しい録画メールを処理しました。`, 
        SpreadsheetApp.getUi().ButtonSet.OK
      );
    }
  } catch (error) {
    console.error(`エラーが発生しました: ${error.message}`);
    
    // 処理履歴にエラーを記録
    logToHistory(
      "システム",
      "エラー",
      `メールチェック中にエラーが発生: ${error.message}`
    );
    
    // 手動実行の場合、エラーを表示
    if (ScriptApp.getTriggerId() === null) {
      SpreadsheetApp.getUi().alert('エラー', `メールチェック中にエラーが発生しました: ${error.message}`, SpreadsheetApp.getUi().ButtonSet.OK);
    }
  }
}/**
 * メール処理の履歴を表示
 */
function viewProcessingHistory() {
  const ui = SpreadsheetApp.getUi();
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  
  // 履歴シートの存在確認と作成
  let historySheet = ss.getSheetByName("処理履歴");
  if (!historySheet) {
    historySheet = ss.insertSheet("処理履歴");
    historySheet.getRange("A1:D1").setValues([["処理日時", "メール件名", "処理結果", "詳細"]]);
    historySheet.getRange("A1:D1").setFontWeight("bold");
    historySheet.setFrozenRows(1);
    historySheet.setColumnWidth(1, 150);
    historySheet.setColumnWidth(2, 300);
    historySheet.setColumnWidth(3, 100);
    historySheet.setColumnWidth(4, 400);
  }
  
  // 表示
  const html = HtmlService.createHtmlOutput(`
    <style>
      body { font-family: Arial, sans-serif; margin: 20px; }
      h2 { color: #4285f4; }
      p { margin-bottom: 20px; }
      button { margin-top: 10px; padding: 8px 15px; background-color: #4285f4; color: white; border: none; border-radius: 3px; cursor: pointer; }
    </style>
    <h2>メール処理履歴</h2>
    <p>メール処理の履歴はスプレッドシートの「処理履歴」シートに記録されています。</p>
    <button onclick="clearHistory()">履歴をクリア</button>
    <button onclick="google.script.host.close()">閉じる</button>
    
    <script>
      function clearHistory() {
        if (confirm('処理履歴をクリアしますか？この操作は元に戻せません。')) {
          google.script.run
            .withSuccessHandler(() => {
              alert('履歴がクリアされました');
            })
            .clearProcessingHistory();
        }
      }
    </script>
  `)
  .setWidth(400)
  .setHeight(250);
  
  ui.showModalDialog(html, '処理履歴');
}

/**
 * 処理履歴をクリア
 */
function clearProcessingHistory() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const historySheet = ss.getSheetByName("処理履歴");
  
  if (historySheet) {
    // ヘッダー行を保持し、それ以外をクリア
    const lastRow = historySheet.getLastRow();
    if (lastRow > 1) {
      historySheet.getRange(2, 1, lastRow - 1, 4).clearContent();
    }
  }
}

/**
 * 処理履歴に記録
 */
function logToHistory(subject, result, details) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let historySheet = ss.getSheetByName("処理履歴");
  
  if (!historySheet) {
    historySheet = ss.insertSheet("処理履歴");
    historySheet.getRange("A1:D1").setValues([["処理日時", "メール件名", "処理結果", "詳細"]]);
    historySheet.getRange("A1:D1").setFontWeight("bold");
    historySheet.setFrozenRows(1);
  }
  
  const now = new Date();
  const timestamp = Utilities.formatDate(now, "Asia/Tokyo", "yyyy/MM/dd HH:mm:ss");
  
  // 新しい行を追加
  const nextRow = historySheet.getLastRow() + 1;
  historySheet.getRange(nextRow, 1).setValue(timestamp);
  historySheet.getRange(nextRow, 2).setValue(subject);
  historySheet.getRange(nextRow, 3).setValue(result);
  historySheet.getRange(nextRow, 4).setValue(details);
}

/**
 * 手動でZoomミーティング情報を追加するダイアログを表示
 */
function showAddMeetingDialog() {
  const html = HtmlService.createHtmlOutput(`
    <style>
      body { font-family: Arial, sans-serif; margin: 20px; }
      h2 { color: #4285f4; }
      label { display: block; margin-top: 15px; font-weight: bold; }
      input, textarea { width: 100%; padding: 8px; margin-top: 5px; }
      button { margin-top: 20px; padding: 10px; background-color: #4285f4; color: white; border: none; border-radius: 5px; cursor: pointer; }
    </style>
    <h2>ミーティング情報の手動追加</h2>
    <form id="meetingForm">
      <label for="meetingName">会議名:</label>
      <input type="text" id="meetingName" name="meetingName" required>
      
      <label for="meetingDate">日時:</label>
      <input type="datetime-local" id="meetingDate" name="meetingDate" required>
      
      <label for="duration">録画時間 (HH:MM:SS):</label>
      <input type="text" id="duration" name="duration" pattern="\\d{2}:\\d{2}:\\d{2}" placeholder="01:30:00" required>
      
      <label for="recordingUrl">録画URL:</label>
      <input type="url" id="recordingUrl" name="recordingUrl" required>
      
      <label for="password">パスワード:</label>
      <input type="text" id="password" name="password" required>
      
      <button type="button" onclick="submitForm()">追加</button>
    </form>
    
    <script>
      // 現在の日時をデフォルトで設定
      document.addEventListener('DOMContentLoaded', function() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        
        document.getElementById('meetingDate').value = `${year}-${month}-${day}T${hours}:${minutes}`;
      });
      
      function submitForm() {
        const form = document.getElementById('meetingForm');
        
        // 簡易バリデーション
        if (!form.checkValidity()) {
          alert('すべての項目を正しく入力してください');
          return;
        }
        
        // データ収集
        const meetingData = {
          meetingName: form.elements.meetingName.value,
          meetingDate: form.elements.meetingDate.value,
          duration: form.elements.duration.value,
          recordingUrl: form.elements.recordingUrl.value,
          password: form.elements.password.value
        };
        
        // サーバーに送信
        google.script.run
          .withSuccessHandler(function() {
            alert('ミーティング情報が追加されました');
            google.script.host.close();
          })
          .withFailureHandler(function(error) {
            alert('エラー: ' + error);
          })
          .addMeetingManually(meetingData);
      }
    </script>
  `)
  .setWidth(500)
  .setHeight(550);
  
  SpreadsheetApp.getUi().showModalDialog(html, 'ミーティング情報の手動追加');
}

/**
 * 手動でミーティング情報を追加
 */
function addMeetingManually(meetingData) {
  try {
    // 日時文字列をDateオブジェクトに変換
    const meetingDate = new Date(meetingData.meetingDate);
    
    // 録画データオブジェクトを作成
    const recordingData = {
      date: meetingDate,
      meetingName: meetingData.meetingName,
      duration: meetingData.duration,
      url: meetingData.recordingUrl,
      password: meetingData.password
    };
    
    // スプレッドシートに情報を記録
    addRecordingToSheet(recordingData);
    
    // Discord通知を送信（オプション）
    const ui = SpreadsheetApp.getUi();
    const sendNotification = ui.alert(
      '通知確認',
      '編集チームにDiscord通知を送信しますか？',
      ui.ButtonSet.YES_NO
    );
    
    if (sendNotification === ui.Button.YES) {
      notifyEditorsDiscord(recordingData);
    }
    
    // 処理履歴に記録
    logToHistory(
      meetingData.meetingName,
      "手動追加",
      `URL: ${meetingData.recordingUrl}, パスワード: ${meetingData.password}`
    );
    
    return true;
  } catch (error) {
    console.error(`手動追加中にエラーが発生しました: ${error.message}`);
    throw error;
  }
}/**
 * 自動処理されたZoomの録画メールを手動で確認する
 */
function viewProcessedEmails() {
  const ui = SpreadsheetApp.getUi();
  
  // 処理済みメールの検索
  const query = `label:${TAG_PROCESSED} from:no-reply@zoom.us subject:"クラウド レコーディング"`;
  const threads = GmailApp.search(query, 0, 10); // 最新10件まで
  
  if (threads.length === 0) {
    ui.alert('情報', '処理済みのZoom録画メールがありません。', ui.ButtonSet.OK);
    return;
  }
  
  // 処理済みメールの一覧を表示
  let html = `
    <style>
      body { font-family: Arial, sans-serif; margin: 20px; }
      h2 { color: #4285f4; }
      table { width: 100%; border-collapse: collapse; margin-top: 20px; }
      th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
      th { background-color: #f2f2f2; }
      tr:hover { background-color: #f5f5f5; }
      .date { width: 150px; }
      .subject { width: 350px; }
      .actions { width: 100px; text-align: center; }
      button { padding: 5px 10px; background-color: #4285f4; color: white; border: none; border-radius: 3px; cursor: pointer; }
    </style>
    <h2>処理済みZoom録画メール</h2>
    <table>
      <tr>
        <th class="date">日付</th>
        <th class="subject">件名</th>
        <th class="actions">操作</th>
      </tr>
  `;
  
  for (let i = 0; i < threads.length; i++) {
    const thread = threads[i];
    const message = thread.getMessages()[0]; // 最初のメッセージ
    const date = Utilities.formatDate(message.getDate(), "Asia/Tokyo", "yyyy/MM/dd HH:mm");
    const subject = message.getSubject();
    
    html += `
      <tr>
        <td class="date">${date}</td>
        <td class="subject">${subject}</td>
        <td class="actions">
          <button onclick="viewEmail(${i})">詳細</button>
        </td>
      </tr>
    `;
  }
  
  html += `
    </table>
    <script>
      function viewEmail(index) {
        google.script.run.viewEmailDetails(index);
      }
    </script>
  `;
  
  const htmlOutput = HtmlService.createHtmlOutput(html)
    .setWidth(600)
    .setHeight(400);
  
  ui.showModalDialog(htmlOutput, '処理済みメール一覧');
  
  // スクリプトプロパティに一時的にスレッドIDを保存
  const threadIds = threads.map(thread => thread.getId());
  PROPERTIES.setProperty('TEMP_THREAD_IDS', JSON.stringify(threadIds));
}

/**
 * 指定されたインデックスのメール詳細を表示
 */
function viewEmailDetails(index) {
  const threadIdsStr = PROPERTIES.getProperty('TEMP_THREAD_IDS');
  if (!threadIdsStr) return;
  
  const threadIds = JSON.parse(threadIdsStr);
  if (index >= threadIds.length) return;
  
  const threadId = threadIds[index];
  const thread = GmailApp.getThreadById(threadId);
  const message = thread.getMessages()[0];
  
  const subject = message.getSubject();
  const date = Utilities.formatDate(message.getDate(), "Asia/Tokyo", "yyyy/MM/dd HH:mm");
  const sender = message.getFrom();
  const body = message.getBody();
  
  const html = `
    <style>
      body { font-family: Arial, sans-serif; margin: 20px; }
      h2 { color: #4285f4; }
      .meta { margin-bottom: 20px; }
      .meta div { margin-bottom: 5px; }
      .label { font-weight: bold; display: inline-block; width: 100px; }
      .content { border: 1px solid #ddd; padding: 15px; background-color: #f9f9f9; }
      button { margin-top: 20px; padding: 8px 15px; background-color: #4285f4; color: white; border: none; border-radius: 3px; cursor: pointer; }
    </style>
    <h2>メール詳細</h2>
    <div class="meta">
      <div><span class="label">件名:</span> ${subject}</div>
      <div><span class="label">日時:</span> ${date}</div>
      <div><span class="label">送信者:</span> ${sender}</div>
    </div>
    <div class="content">${body}</div>
    <button onclick="reprocess()">再処理する</button>
    <button onclick="goBack()">戻る</button>
    
    <script>
      function reprocess() {
        if (confirm('このメールを再処理しますか？')) {
          google.script.run
            .withSuccessHandler(() => {
              google.script.host.close();
            })
            .reprocessEmail(${index});
        }
      }
      
      function goBack() {
        google.script.run.viewProcessedEmails();
      }
    </script>
  `;
  
  const htmlOutput = HtmlService.createHtmlOutput(html)
    .setWidth(700)
    .setHeight(500);
  
  SpreadsheetApp.getUi().showModalDialog(htmlOutput, 'メール詳細');
}

/**
 * 指定されたメールを再処理する
 */
function reprocessEmail(index) {
  const threadIdsStr = PROPERTIES.getProperty('TEMP_THREAD_IDS');
  if (!threadIdsStr) return;
  
  const threadIds = JSON.parse(threadIdsStr);
  if (index >= threadIds.length) return;
  
  try {
    const threadId = threadIds[index];
    const thread = GmailApp.getThreadById(threadId);
    const message = thread.getMessages()[0];
    
    // タグを変更
    thread.removeLabel(GmailApp.getUserLabelByName(TAG_PROCESSED));
    thread.addLabel(GmailApp.getUserLabelByName(TAG_RECORDING));
    
    // 再処理をトリガー
    checkZoomEmails();
    
    SpreadsheetApp.getUi().alert('完了', 'メールを再処理しました。', SpreadsheetApp.getUi().ButtonSet.OK);
  } catch (error) {
    SpreadsheetApp.getUi().alert('エラー', `再処理中にエラーが発生しました: ${error.message}`, SpreadsheetApp.getUi().ButtonSet.OK);
  }
}/**
 * Zoom録画自動処理システム
 * 
 * このスクリプトは以下の機能を提供します：
 * 1. Gmailから「録画」タグ付きメールを定期的に検索
 * 2. メールからZoom録画のURLとパスワードを抽出
 * 3. 情報をスプレッドシートに記録
 * 4. Discord WebhookでDiscordに通知
 * 5. 処理済みメールのタグを変更
 * 6. YouTubeアップロード後の通知ボタン機能
 */

// グローバル変数
const PROPERTIES = PropertiesService.getScriptProperties();
const SHEET_NAME_RECORDINGS = "録画管理";
const SHEET_NAME_SETTINGS = "設定";
const TAG_RECORDING = "録画";
const TAG_PROCESSED = "録画処理済み";

/**
 * メインメニューを追加するためのonOpen関数
 */
function onOpen() {
  // カスタムメニューを追加
  const ui = SpreadsheetApp.getUi();
  ui.createMenu('Zoom録画管理')
    .addItem('システム設定', 'showSettingsDialog')
    .addItem('Webhook設定', 'showWebhookSettingsDialog')
    .addItem('トリガー設定', 'setupTriggers')
    .addItem('手動でメール確認', 'checkZoomEmails')
    .addItem('手動で受講生に通知', 'manuallyNotifyStudents')
    .addItem('手動で録画情報を追加', 'showAddMeetingDialog')
    .addItem('処理済みメールを表示', 'viewProcessedEmails')
    .addItem('処理履歴を表示', 'viewProcessingHistory')
    .addItem('スプレッドシート初期化', 'initializeSpreadsheet')
    .addToUi();
  
  // 設定が未完了の場合は設定ダイアログを表示
  if (!areSettingsComplete()) {
    showSettingsDialog();
  }
}

/**
 * 設定が完了しているかをチェック
 */
function areSettingsComplete() {
  const editorsWebhook = PROPERTIES.getProperty('DISCORD_WEBHOOK_EDITORS');
  const studentsWebhook = PROPERTIES.getProperty('DISCORD_WEBHOOK_STUDENTS');
  return editorsWebhook && studentsWebhook;
}

/**
 * システム設定ダイアログを表示
 */
function showSettingsDialog() {
  const html = HtmlService.createHtmlOutput(`
    <style>
      body { font-family: Arial, sans-serif; margin: 20px; }
      label { display: block; margin-top: 15px; font-weight: bold; }
      input { width: 100%; padding: 5px; margin-top: 5px; }
      button { margin-top: 20px; padding: 10px; background-color: #4285f4; color: white; border: none; border-radius: 5px; }
      .tabs { display: flex; margin-bottom: 20px; }
      .tab { padding: 10px 15px; cursor: pointer; border: 1px solid #ccc; border-bottom: none; }
      .tab.active { background-color: #f0f0f0; }
      .tab-content { display: none; }
      .tab-content.active { display: block; }
    </style>
    <h2>システム設定</h2>
    
    <div class="tabs">
      <div class="tab active" onclick="showTab('general')">一般設定</div>
      <div class="tab" onclick="showTab('email')">メール設定</div>
      <div class="tab" onclick="showTab('discord')">Discord設定</div>
    </div>
    
    <form id="settingsForm">
      <div id="general" class="tab-content active">
        <label for="checkInterval">メールチェック間隔（分）:</label>
        <input type="number" id="checkInterval" name="checkInterval" min="5" max="60" value="${PROPERTIES.getProperty('CHECK_INTERVAL') || '15'}">
        
        <label for="webhookCheckInterval">Webhook確認間隔（時間）:</label>
        <input type="number" id="webhookCheckInterval" name="webhookCheckInterval" min="1" max="24" value="${PROPERTIES.getProperty('WEBHOOK_CHECK_INTERVAL') || '12'}">
      </div>
      
      <div id="email" class="tab-content">
        <label for="zoomSender">Zoom送信元メールアドレス:</label>
        <input type="text" id="zoomSender" name="zoomSender" value="${PROPERTIES.getProperty('ZOOM_SENDER') || 'no-reply@zoom.us'}">
        
        <label for="zoomSubject">Zoom録画メールの件名キーワード:</label>
        <input type="text" id="zoomSubject" name="zoomSubject" value="${PROPERTIES.getProperty('ZOOM_SUBJECT') || 'クラウド レコーディング'}">
        
        <button type="button" onclick="setupEmailFilter()">Gmailフィルターを設定</button>
      </div>
      
      <div id="discord" class="tab-content">
        <label for="editorsWebhook">編集チーム向け Discord Webhook URL:</label>
        <input type="text" id="editorsWebhook" name="editorsWebhook" value="${PROPERTIES.getProperty('DISCORD_WEBHOOK_EDITORS') || ''}">
        
        <label for="studentsWebhook">受講者向け Discord Webhook URL:</label>
        <input type="text" id="studentsWebhook" name="studentsWebhook" value="${PROPERTIES.getProperty('DISCORD_WEBHOOK_STUDENTS') || ''}">
        
        <button type="button" onclick="testWebhooks()">Webhookをテスト</button>
      </div>
      
      <button type="button" onclick="saveAllSettings()" style="margin-top: 30px;">すべての設定を保存</button>
    </form>
    
    <script>
      function showTab(tabId) {
        // すべてのタブとコンテンツを非アクティブに
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        
        // 選択したタブとコンテンツをアクティブに
        document.querySelector('.tab[onclick*="' + tabId + '"]').classList.add('active');
        document.getElementById(tabId).classList.add('active');
      }
      
      function saveAllSettings() {
        const form = document.getElementById('settingsForm');
        const settings = {
          checkInterval: form.elements.checkInterval.value,
          webhookCheckInterval: form.elements.webhookCheckInterval.value,
          zoomSender: form.elements.zoomSender.value,
          zoomSubject: form.elements.zoomSubject.value,
          editorsWebhook: form.elements.editorsWebhook.value,
          studentsWebhook: form.elements.studentsWebhook.value
        };
        
        google.script.run
          .withSuccessHandler(() => {
            google.script.host.close();
          })
          .saveAllSettings(settings);
      }
      
      function setupEmailFilter() {
        google.script.run.setupZoomEmailFilter();
      }
      
      function testWebhooks() {
        const editorsWebhook = document.getElementById('editorsWebhook').value;
        const studentsWebhook = document.getElementById('studentsWebhook').value;
        
        google.script.run
          .withSuccessHandler(result => {
            alert(result);
          })
          .testDiscordWebhooks(editorsWebhook, studentsWebhook);
      }
    </script>
  `)
  .setWidth(600)
  .setHeight(500);
  
  SpreadsheetApp.getUi().showModalDialog(html, 'システム設定');
}

/**
 * Webhook設定ダイアログを表示
 */
function showWebhookSettingsDialog() {
  const html = HtmlService.createHtmlOutput(`
    <style>
      body { font-family: Arial, sans-serif; margin: 20px; }
      h3 { color: #4285f4; margin-top: 20px; }
      label { display: block; margin-top: 15px; font-weight: bold; }
      input { width: 100%; padding: 5px; margin-top: 5px; }
      button { margin-top: 20px; padding: 10px; background-color: #4285f4; color: white; border: none; border-radius: 5px; }
      .status { margin-top: 10px; padding: 8px; border-radius: 4px; }
      .status.valid { background-color: #d4edda; color: #155724; }
      .status.invalid { background-color: #f8d7da; color: #721c24; }
    </style>
    <h2>Discord Webhook設定</h2>
    
    <form id="webhookForm">
      <h3>編集チーム向け Webhook</h3>
      <label for="editorsWebhook">Webhook URL:</label>
      <input type="text" id="editorsWebhook" name="editorsWebhook" value="${PROPERTIES.getProperty('DISCORD_WEBHOOK_EDITORS') || ''}">
      <div id="editorsStatus" class="status"></div>
      
      <h3>受講者向け Webhook</h3>
      <label for="studentsWebhook">Webhook URL:</label>
      <input type="text" id="studentsWebhook" name="studentsWebhook" value="${PROPERTIES.getProperty('DISCORD_WEBHOOK_STUDENTS') || ''}">
      <div id="studentsStatus" class="status"></div>
      
      <button type="button" onclick="validateWebhooks()">Webhookを検証</button>
      <button type="button" onclick="saveWebhooks()">保存</button>
    </form>
    
    <script>
      function validateWebhooks() {
        const editorsWebhook = document.getElementById('editorsWebhook').value;
        const studentsWebhook = document.getElementById('studentsWebhook').value;
        
        // 編集者向けWebhookの検証
        if (editorsWebhook) {
          document.getElementById('editorsStatus').textContent = '検証中...';
          document.getElementById('editorsStatus').className = 'status';
          
          google.script.run
            .withSuccessHandler(result => {
              const status = document.getElementById('editorsStatus');
              if (result === 'valid') {
                status.textContent = '✓ 有効なWebhookです';
                status.className = 'status valid';
              } else {
                status.textContent = '✗ 無効なWebhook: ' + result;
                status.className = 'status invalid';
              }
            })
            .validateWebhook(editorsWebhook);
        }
        
        // 受講者向けWebhookの検証
        if (studentsWebhook) {
          document.getElementById('studentsStatus').textContent = '検証中...';
          document.getElementById('studentsStatus').className = 'status';
          
          google.script.run
            .withSuccessHandler(result => {
              const status = document.getElementById('studentsStatus');
              if (result === 'valid') {
                status.textContent = '✓ 有効なWebhookです';
                status.className = 'status valid';
              } else {
                status.textContent = '✗ 無効なWebhook: ' + result;
                status.className = 'status invalid';
              }
            })
            .validateWebhook(studentsWebhook);
        }
      }
      
      function saveWebhooks() {
        const form = document.getElementById('webhookForm');
        const editorsWebhook = form.elements.editorsWebhook.value;
        const studentsWebhook = form.elements.studentsWebhook.value;
        
        google.script.run
          .withSuccessHandler(() => {
            google.script.host.close();
          })
          .saveSettings(editorsWebhook, studentsWebhook);
      }
    </script>
  `)
  .setWidth(600)
  .setHeight(450);
  
  SpreadsheetApp.getUi().showModalDialog(html, 'Discord Webhook設定');
}

/**
 * 設定を保存
 */
function saveSettings(editorsWebhook, studentsWebhook) {
  PROPERTIES.setProperty('DISCORD_WEBHOOK_EDITORS', editorsWebhook);
  PROPERTIES.setProperty('DISCORD_WEBHOOK_STUDENTS', studentsWebhook);
  
  // 必要に応じてシート構造を初期化
  initializeSpreadsheet();
  
  // 定期実行トリガーがなければ設定
  setTriggerIfNeeded();
}

/**
 * すべての設定を保存
 */
function saveAllSettings(settings) {
  // 一般設定
  PROPERTIES.setProperty('CHECK_INTERVAL', settings.checkInterval);
  PROPERTIES.setProperty('WEBHOOK_CHECK_INTERVAL', settings.webhookCheckInterval);
  
  // メール設定
  PROPERTIES.setProperty('ZOOM_SENDER', settings.zoomSender);
  PROPERTIES.setProperty('ZOOM_SUBJECT', settings.zoomSubject);
  
  // Discord設定
  PROPERTIES.setProperty('DISCORD_WEBHOOK_EDITORS', settings.editorsWebhook);
  PROPERTIES.setProperty('DISCORD_WEBHOOK_STUDENTS', settings.studentsWebhook);
  
  // 設定シートを更新
  updateSettingsSheet();
  
  // 必要に応じてシート構造を初期化
  initializeSpreadsheet();
  
  // トリガーを更新
  updateTriggers();
  
  // 完了メッセージ
  SpreadsheetApp.getUi().alert('設定の保存', '設定が保存されました。', SpreadsheetApp.getUi().ButtonSet.OK);
}

/**
 * 設定シートの内容を更新
 */
function updateSettingsSheet() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const settingsSheet = ss.getSheetByName(SHEET_NAME_SETTINGS);
  
  if (!settingsSheet) return;
  
  // プロパティから値を設定
  settingsSheet.getRange("B2").setValue(PROPERTIES.getProperty('DISCORD_WEBHOOK_EDITORS') || '');
  settingsSheet.getRange("B3").setValue(PROPERTIES.getProperty('DISCORD_WEBHOOK_STUDENTS') || '');
  settingsSheet.getRange("B4").setValue(PROPERTIES.getProperty('WEBHOOK_CHECK_INTERVAL') || '12');
}

/**
 * トリガーを設定間隔に合わせて更新
 */
function updateTriggers() {
  // 既存のトリガーを削除
  const triggers = ScriptApp.getProjectTriggers();
  for (const trigger of triggers) {
    if (trigger.getHandlerFunction() === 'checkZoomEmails' || 
        trigger.getHandlerFunction() === 'checkWebhookStatus') {
      ScriptApp.deleteTrigger(trigger);
    }
  }
  
  // メールチェックトリガーを設定
  const checkInterval = Number(PROPERTIES.getProperty('CHECK_INTERVAL')) || 15;
  ScriptApp.newTrigger('checkZoomEmails')
    .timeBased()
    .everyMinutes(checkInterval)
    .create();
  
  // Webhook確認トリガーを設定
  const webhookCheckInterval = Number(PROPERTIES.getProperty('WEBHOOK_CHECK_INTERVAL')) || 12;
  ScriptApp.newTrigger('checkWebhookStatus')
    .timeBased()
    .everyHours(webhookCheckInterval)
    .create();
}

/**
 * Discord Webhookの有効性を検証
 */
function validateWebhook(webhookUrl) {
  if (!webhookUrl) return 'URLが指定されていません';
  
  try {
    const options = {
      method: 'get',
      muteHttpExceptions: true
    };
    
    const response = UrlFetchApp.fetch(webhookUrl, options);
    const code = response.getResponseCode();
    
    if (code === 200) {
      return 'valid';
    } else {
      return `HTTPエラー: ${code}`;
    }
  } catch (error) {
    return `エラー: ${error.message}`;
  }
}

/**
 * Discord Webhookをテスト
 */
function testDiscordWebhooks(editorsWebhook, studentsWebhook) {
  let results = '';
  
  // 編集チーム向けWebhookのテスト
  if (editorsWebhook) {
    try {
      const message = {
        content: "🧪 **Webhook テスト** 🧪",
        embeds: [{
          title: "編集チーム向けWebhookのテスト",
          description: "このメッセージは、Webhook URLが正常に動作していることを確認するためのテストです。",
          color: 5814783, // 青色
          timestamp: new Date().toISOString()
        }]
      };
      
      const options = {
        method: "post",
        contentType: "application/json",
        payload: JSON.stringify(message),
        muteHttpExceptions: true
      };
      
      const response = UrlFetchApp.fetch(editorsWebhook, options);
      const code = response.getResponseCode();
      
      if (code === 204) {
        results += "✅ 編集チーム向けWebhook: 正常に通知を送信しました\n\n";
      } else {
        results += `❌ 編集チーム向けWebhook: エラー (HTTP ${code})\n\n`;
      }
    } catch (error) {
      results += `❌ 編集チーム向けWebhook: ${error.message}\n\n`;
    }
  } else {
    results += "⚠️ 編集チーム向けWebhook: URLが設定されていません\n\n";
  }
  
  // 受講者向けWebhookのテスト
  if (studentsWebhook) {
    try {
      const message = {
        content: "🧪 **Webhook テスト** 🧪",
        embeds: [{
          title: "受講者向けWebhookのテスト",
          description: "このメッセージは、Webhook URLが正常に動作していることを確認するためのテストです。",
          color: 16711680, // 赤色
          timestamp: new Date().toISOString()
        }]
      };
      
      const options = {
        method: "post",
        contentType: "application/json",
        payload: JSON.stringify(message),
        muteHttpExceptions: true
      };
      
      const response = UrlFetchApp.fetch(studentsWebhook, options);
      const code = response.getResponseCode();
      
      if (code === 204) {
        results += "✅ 受講者向けWebhook: 正常に通知を送信しました";
      } else {
        results += `❌ 受講者向けWebhook: エラー (HTTP ${code})`;
      }
    } catch (error) {
      results += `❌ 受講者向けWebhook: ${error.message}`;
    }
  } else {
    results += "⚠️ 受講者向けWebhook: URLが設定されていません";
  }
  
  return results;
}

/**
 * ヘルプダイアログを表示
 */
function showHelpDialog() {
  const html = HtmlService.createHtmlOutput(`
    <style>
      body { font-family: Arial, sans-serif; margin: 20px; }
      h3 { color: #4285f4; }
      li { margin-bottom: 10px; }
    </style>
    <h2>Zoom録画自動処理システム - ヘルプ</h2>
    <h3>基本的な使い方</h3>
    <ol>
      <li>Zoom会議が終了すると、「録画」タグ付きメールが届きます</li>
      <li>システムは15分ごとに自動的にメールをチェックします</li>
      <li>録画情報がスプレッドシートに追加され、Discordに通知されます</li>
      <li>編集者は録画をダウンロードし、YouTubeにアップロードします</li>
      <li>アップロード後、スプレッドシートのボタンをクリックして受講者に通知します</li>
    </ol>
    
    <h3>手動操作</h3>
    <ul>
      <li>「手動でメールチェック」メニューを使用して即時チェックができます</li>
      <li>「YouTube URL」と「説明」を入力してから「Discord通知」ボタンをクリックしてください</li>
    </ul>
    
    <h3>トラブルシューティング</h3>
    <ul>
      <li>録画メールが検出されない場合、「録画」タグが正しく付いているか確認してください</li>
      <li>Discord通知が届かない場合、Webhook URLの設定を確認してください</li>
    </ul>
  `)
  .setWidth(600)
  .setHeight(400);
  
  SpreadsheetApp.getUi().showModalDialog(html, 'ヘルプ');
}

/**
 * スプレッドシートの初期化
 */
function initializeSpreadsheet() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  
  // 録画管理シートの初期化
  let recordingsSheet = ss.getSheetByName(SHEET_NAME_RECORDINGS);
  if (!recordingsSheet) {
    recordingsSheet = ss.insertSheet(SHEET_NAME_RECORDINGS);
    
    // ヘッダー行を設定
    recordingsSheet.getRange("A1:I1").setValues([["日付", "会議名", "録画時間", "共有URL", "パスワード", "YouTube URL", "YouTube説明", "処理状態", "通知"]]);
    recordingsSheet.getRange("A1:I1").setFontWeight("bold");
    recordingsSheet.setFrozenRows(1);
    
    // 列幅を調整
    recordingsSheet.setColumnWidth(1, 100); // 日付
    recordingsSheet.setColumnWidth(2, 200); // 会議名
    recordingsSheet.setColumnWidth(3, 80);  // 録画時間
    recordingsSheet.setColumnWidth(4, 300); // 共有URL
    recordingsSheet.setColumnWidth(5, 100); // パスワード
    recordingsSheet.setColumnWidth(6, 300); // YouTube URL
    recordingsSheet.setColumnWidth(7, 300); // YouTube説明
    recordingsSheet.setColumnWidth(8, 100); // 処理状態
    recordingsSheet.setColumnWidth(9, 100); // 通知ボタン
    
    // ダミーデータを挿入
    insertDummyData(recordingsSheet);
  }
  
  // 設定シートの初期化
  let settingsSheet = ss.getSheetByName(SHEET_NAME_SETTINGS);
  if (!settingsSheet) {
    settingsSheet = ss.insertSheet(SHEET_NAME_SETTINGS);
    
    // 設定項目を追加
    settingsSheet.getRange("A1:B1").setValues([["設定項目", "値"]]);
    settingsSheet.getRange("A1:B1").setFontWeight("bold");
    settingsSheet.getRange("A2").setValue("編集チーム向けDiscord webhook URL");
    settingsSheet.getRange("A3").setValue("受講者向けDiscord webhook URL");
    settingsSheet.getRange("A4").setValue("Webhook確認間隔（時間）");
    settingsSheet.getRange("B4").setValue("12");
    settingsSheet.getRange("A5").setValue("最終Webhook確認日時");
    settingsSheet.getRange("B5").setValue(new Date());
    
    // 列幅を調整
    settingsSheet.setColumnWidth(1, 300);
    settingsSheet.setColumnWidth(2, 500);
    
    // プロパティから値を設定
    settingsSheet.getRange("B2").setValue(PROPERTIES.getProperty('DISCORD_WEBHOOK_EDITORS') || '');
    settingsSheet.getRange("B3").setValue(PROPERTIES.getProperty('DISCORD_WEBHOOK_STUDENTS') || '');
  }
  
  // 通知ボタンを追加するオンエディットトリガーを設定
  setOnEditTriggerIfNeeded();
  
  // Webhook確認トリガーを設定
  setWebhookCheckTriggerIfNeeded();
}

/**
 * ダミーデータをスプレッドシートに挿入
 */
function insertDummyData(sheet) {
  // 現在日時から過去のデータを作成
  const now = new Date();
  
  // サンプルデータ
  const dummyData = [
    // 1週間前のデータ - 通知済み
    {
      date: new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000),
      meetingName: "ウェブ開発入門講座 #1",
      duration: "01:15:30",
      url: "https://us06web.zoom.us/rec/share/sample-url-for-lesson1",
      password: "Abc123",
      youtubeUrl: "https://youtu.be/sample-youtube-url-1",
      description: "【ウェブ開発入門】HTML/CSSの基礎について学習します。初回はウェブの仕組みとHTMLの基本構造を解説しています。",
      status: "通知済み",
      notification: "✓ 完了"
    },
    // 3日前のデータ - 編集済み
    {
      date: new Date(now.getTime() - 3 * 24 * 60 * 60 * 1000),
      meetingName: "ウェブ開発入門講座 #2",
      duration: "01:23:45",
      url: "https://us06web.zoom.us/rec/share/sample-url-for-lesson2",
      password: "Def456",
      youtubeUrl: "https://youtu.be/sample-youtube-url-2",
      description: "【ウェブ開発入門】CSSを使ったスタイリングの基本とレスポンシブデザインについて解説しています。",
      status: "編集済み",
      notification: "Discordに通知"
    },
    // 1日前のデータ - 未処理
    {
      date: new Date(now.getTime() - 1 * 24 * 60 * 60 * 1000),
      meetingName: "ウェブ開発入門講座 #3",
      duration: "01:30:00",
      url: "https://us06web.zoom.us/rec/share/sample-url-for-lesson3",
      password: "Ghi789",
      youtubeUrl: "",
      description: "",
      status: "未処理",
      notification: ""
    }
  ];
  
  // データを挿入
  for (let i = 0; i < dummyData.length; i++) {
    const data = dummyData[i];
    const row = i + 2; // ヘッダー行の次から
    
    sheet.getRange(row, 1).setValue(data.date);
    sheet.getRange(row, 2).setValue(data.meetingName);
    sheet.getRange(row, 3).setValue(data.duration);
    
    // URLをハイパーリンクとして設定
    if (data.url) {
      sheet.getRange(row, 4).setFormula(`=HYPERLINK("${data.url}", "${data.url}")`);
    } else {
      sheet.getRange(row, 4).setValue(data.url);
    }
    
    sheet.getRange(row, 5).setValue(data.password);
    
    // YouTube URLをハイパーリンクとして設定
    if (data.youtubeUrl) {
      sheet.getRange(row, 6).setFormula(`=HYPERLINK("${data.youtubeUrl}", "${data.youtubeUrl}")`);
    } else {
      sheet.getRange(row, 6).setValue(data.youtubeUrl);
    }
    
    sheet.getRange(row, 7).setValue(data.description);
    sheet.getRange(row, 8).setValue(data.status);
    
    // 通知ボタンのスタイリング
    sheet.getRange(row, 9).setValue(data.notification);
    
    if (data.notification === "Discordに通知") {
      sheet.getRange(row, 9)
        .setFontColor("blue")
        .setFontWeight("bold")
        .setHorizontalAlignment("center")
        .setBackground("#e6f2ff");
    } else if (data.notification === "✓ 完了") {
      sheet.getRange(row, 9)
        .setFontColor("green")
        .setFontWeight("bold")
        .setHorizontalAlignment("center");
    }
  }
}

/**
 * 定期実行トリガーの設定（15分ごと）
 */
function setTriggerIfNeeded() {
  const triggers = ScriptApp.getProjectTriggers();
  let exists = false;
  
  // 既存のトリガーをチェック
  for (const trigger of triggers) {
    if (trigger.getHandlerFunction() === 'checkZoomEmails') {
      exists = true;
      break;
    }
  }
  
  // トリガーが存在しない場合は作成
  if (!exists) {
    ScriptApp.newTrigger('checkZoomEmails')
      .timeBased()
      .everyMinutes(15)
      .create();
  }
}

/**
 * Webhook確認トリガーの設定（12時間ごと）
 */
function setWebhookCheckTriggerIfNeeded() {
  const triggers = ScriptApp.getProjectTriggers();
  let exists = false;
  
  // 既存のトリガーをチェック
  for (const trigger of triggers) {
    if (trigger.getHandlerFunction() === 'checkWebhookStatus') {
      exists = true;
      break;
    }
  }
  
  // トリガーが存在しない場合は作成
  if (!exists) {
    ScriptApp.newTrigger('checkWebhookStatus')
      .timeBased()
      .everyHours(12)
      .create();
  }
}

/**
 * Discord Webhookの状態を確認する
 * 12時間ごとに実行され、Webhookが有効かどうかを確認
 */
function checkWebhookStatus() {
  try {
    // スプレッドシートから設定を取得
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const settingsSheet = ss.getSheetByName(SHEET_NAME_SETTINGS);
    
    // 確認間隔（時間）を取得
    const checkInterval = Number(settingsSheet.getRange("B4").getValue()) || 12;
    
    // 前回の確認日時を取得
    const lastChecked = new Date(settingsSheet.getRange("B5").getValue());
    const now = new Date();
    
    // 前回の確認から指定時間が経過していなければスキップ
    const hoursSinceLastCheck = (now - lastChecked) / (1000 * 60 * 60);
    if (hoursSinceLastCheck < checkInterval) {
      console.log(`前回の確認から${hoursSinceLastCheck}時間しか経過していないためスキップします (確認間隔: ${checkInterval}時間)`);
      return;
    }
    
    // Webhookの状態を確認
    const editorsWebhook = PROPERTIES.getProperty('DISCORD_WEBHOOK_EDITORS');
    const studentsWebhook = PROPERTIES.getProperty('DISCORD_WEBHOOK_STUDENTS');
    
    let editorsStatus = "未設定";
    let studentsStatus = "未設定";
    
    // 編集チーム向けWebhookの確認
    if (editorsWebhook) {
      try {
        const response = UrlFetchApp.fetch(editorsWebhook, { method: "get", muteHttpExceptions: true });
        editorsStatus = (response.getResponseCode() === 200) ? "有効" : "無効";
      } catch (e) {
        editorsStatus = "エラー: " + e.message;
      }
    }
    
    // 受講者向けWebhookの確認
    if (studentsWebhook) {
      try {
        const response = UrlFetchApp.fetch(studentsWebhook, { method: "get", muteHttpExceptions: true });
        studentsStatus = (response.getResponseCode() === 200) ? "有効" : "無効";
      } catch (e) {
        studentsStatus = "エラー: " + e.message;
      }
    }
    
    // ログに記録
    console.log(`Webhook確認結果 - 編集チーム: ${editorsStatus}, 受講者: ${studentsStatus}`);
    
    // 結果をシートに記録
    settingsSheet.getRange("A6").setValue("編集チーム向けWebhook状態");
    settingsSheet.getRange("B6").setValue(editorsStatus);
    settingsSheet.getRange("A7").setValue("受講者向けWebhook状態");
    settingsSheet.getRange("B7").setValue(studentsStatus);
    
    // 最終確認日時を更新
    settingsSheet.getRange("B5").setValue(now);
    
    // いずれかのWebhookが有効でない場合は管理者に通知（メール送信など）
    if (editorsStatus !== "有効" || studentsStatus !== "有効") {
      sendWebhookAlert(editorsStatus, studentsStatus);
    }
  } catch (error) {
    console.error(`Webhook確認中にエラーが発生しました: ${error.message}`);
  }
}

/**
 * Webhookに問題がある場合のアラート送信
 */
function sendWebhookAlert(editorsStatus, studentsStatus) {
  try {
    // スクリプトを実行しているユーザーのメールアドレスを取得
    const email = Session.getActiveUser().getEmail();
    
    // メール本文を作成
    const subject = "[警告] Discord Webhookに問題があります";
    const body = `
      Zoom録画自動処理システムからの通知です。
      
      Discord Webhookの状態確認を行ったところ、問題が見つかりました。
      
      - 編集チーム向けWebhook: ${editorsStatus}
      - 受講者向けWebhook: ${studentsStatus}
      
      スプレッドシートの「システム設定」から設定を確認し、必要に応じて更新してください。
      
      このメールは自動送信されています。
    `;
    
    // メール送信
    MailApp.sendEmail(email, subject, body);
    console.log(`警告メールを ${email} に送信しました`);
  } catch (error) {
    console.error(`アラートメール送信中にエラーが発生しました: ${error.message}`);
  }
}

/**
 * onEditトリガーの設定
 */
function setOnEditTriggerIfNeeded() {
  const triggers = ScriptApp.getProjectTriggers();
  let exists = false;
  
  // 既存のトリガーをチェック
  for (const trigger of triggers) {
    if (trigger.getHandlerFunction() === 'onEdit') {
      exists = true;
      break;
    }
  }
  
  // トリガーが存在しない場合は作成
  if (!exists) {
    ScriptApp.newTrigger('onEdit')
      .forSpreadsheet(SpreadsheetApp.getActiveSpreadsheet())
      .onEdit()
      .create();
  }
}

/**
 * スプレッドシート編集時の処理
 */
function onEdit(e) {
  const range = e.range;
  const sheet = range.getSheet();
  
  // 録画管理シートの場合のみ処理
  if (sheet.getName() !== SHEET_NAME_RECORDINGS) return;
  
  // H列（処理状態）が「編集済み」に変更された場合、通知ボタンを追加
  if (range.getColumn() === 8 && range.getValue() === "編集済み") {
    const row = range.getRow();
    
    // 通知ボタンをセットアップ
    const notifyCell = sheet.getRange(row, 9);
    notifyCell.setValue("Discordに通知");
    notifyCell.setFontColor("blue");
    notifyCell.setFontWeight("bold");
    notifyCell.setHorizontalAlignment("center");
    
    // セルの背景色を設定
    notifyCell.setBackground("#e6f2ff");
  }
}

/**
 * トリガー設定用の専用関数
 */
function setupTriggers() {
  const ui = SpreadsheetApp.getUi();
  const result = ui.alert(
    'トリガー設定',
    '以下のトリガーを設定します：\n\n' +
    '・15分ごとのメールチェック\n' +
    '・12時間ごとのWebhook確認\n\n' +
    '既存のトリガーは削除されます。続行しますか？',
    ui.ButtonSet.YES_NO
  );
  
  if (result === ui.Button.YES) {
    // 既存のトリガーをすべて削除
    const triggers = ScriptApp.getProjectTriggers();
    for (const trigger of triggers) {
      ScriptApp.deleteTrigger(trigger);
    }
    
    // メールチェックトリガーを設定
    ScriptApp.newTrigger('checkZoomEmails')
      .timeBased()
      .everyMinutes(15)
      .create();
    
    // Webhook確認トリガーを設定
    ScriptApp.newTrigger('checkWebhookStatus')
      .timeBased()
      .everyHours(12)
      .create();
    
    ui.alert('トリガー設定', 'トリガーの設定が完了しました。', ui.ButtonSet.OK);
  }
}

/**
 * 手動で受講生に通知する関数
 */
function manuallyNotifyStudents() {
  const ui = SpreadsheetApp.getUi();
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(SHEET_NAME_RECORDINGS);
  
  if (!sheet) {
    ui.alert('エラー', '録画管理シートが見つかりません。', ui.ButtonSet.OK);
    return;
  }
  
  const activeRow = sheet.getActiveCell().getRow();
  if (activeRow <= 1) {
    ui.alert('エラー', '通知したい録画の行を選択してから実行してください。', ui.ButtonSet.OK);
    return;
  }
  
  // 選択された行のデータを取得
  const meetingName = sheet.getRange(activeRow, 2).getValue();
  const youtubeUrl = sheet.getRange(activeRow, 6).getValue();
  const description = sheet.getRange(activeRow, 7).getValue();
  
  if (!youtubeUrl) {
    ui.alert('エラー', 'YouTube URLが入力されていません。', ui.ButtonSet.OK);
    return;
  }
  
  // 確認ダイアログを表示
  const confirmResult = ui.alert(
    '確認',
    `以下の内容で受講生に通知しますか？\n\n` +
    `タイトル: ${meetingName}\n` +
    `YouTube: ${youtubeUrl}\n` +
    `説明: ${description}\n`,
    ui.ButtonSet.YES_NO
  );
  
  if (confirmResult === ui.Button.YES) {
    try {
      // Discord通知を送信
      notifyStudentsDiscord(meetingName, youtubeUrl, description);
      
      // 処理状態を更新
      sheet.getRange(activeRow, 8).setValue("通知済み");
      sheet.getRange(activeRow, 9).setValue("✓ 完了").setFontColor("green");
      
      ui.alert('成功', 'Discord通知が正常に送信されました。', ui.ButtonSet.OK);
    } catch (error) {
      ui.alert('エラー', `通知の送信に失敗しました: ${error.message}`, ui.ButtonSet.OK);
    }
  }
}

/**
 * Zoomの録画メールをチェック（定期実行および手動実行用）
 */
function checkZoomEmails() {
  try {
    // メールチェックの前に、必要なタグが存在するか確認し、なければ作成
    ensureGmailLabelsExist();
    
    // 「録画」タグ付きメールを検索
    const query = `label:${TAG_RECORDING} from:no-reply@zoom.us subject:"クラウド レコーディング"`;
    const threads = GmailApp.search(query, 0, 10); // 最新10件まで処理
    
    // 手動実行の場合、結果を表示
    const isManualRun = ScriptApp.getScriptId() === ScriptApp.getActiveId();
    if (isManualRun && threads.length === 0) {
      SpreadsheetApp.getUi().alert('メールチェック', '新しい録画メールはありません。', SpreadsheetApp.getUi().ButtonSet.OK);
      return;
    }
    
    console.log(`${threads.length}件の録画メールを処理します`);
    let processedCount = 0;
    
    for (const thread of threads) {
      const messages = thread.getMessages();
      
      for (const message of messages) {
        // 処理済みかどうかをチェック（タグが変更されている可能性があるため）
        if (isMessageProcessed(message)) continue;
        
        // メールからデータを抽出
        const recordingData = extractRecordingData(message);
        
        if (recordingData) {
          // スプレッドシートに情報を記録
          addRecordingToSheet(recordingData);
          
          // Discord通知を送信
          notifyEditorsDiscord(recordingData);
          
          // メールのタグを変更
          changeMessageTag(message);
          
          processedCount++;
          console.log(`メールID: ${message.getId()} の処理が完了しました`);
        } else {
          console.log(`メールID: ${message.getId()} からデータを抽出できませんでした`);
        }
      }
    }
    
    // 手動実行の場合、結果を表示
    if (isManualRun) {
      SpreadsheetApp.getUi().alert(
        'メールチェック', 
        `${processedCount}件の新しい録画メールを処理しました。`, 
        SpreadsheetApp.getUi().ButtonSet.OK
      );
    }
  } catch (error) {
    console.error(`エラーが発生しました: ${error.message}`);
    
    // 手動実行の場合、エラーを表示
    if (ScriptApp.getScriptId() === ScriptApp.getActiveId()) {
      SpreadsheetApp.getUi().alert('エラー', `メールチェック中にエラーが発生しました: ${error.message}`, SpreadsheetApp.getUi().ButtonSet.OK);
    }
  }
}

/**
 * Gmailのラベル（タグ）が存在することを確認し、なければ作成
 */
function ensureGmailLabelsExist() {
  // 「録画」タグが存在するかチェック
  let recordingLabel = GmailApp.getUserLabelByName(TAG_RECORDING);
  if (!recordingLabel) {
    recordingLabel = GmailApp.createLabel(TAG_RECORDING);
    console.log(`「${TAG_RECORDING}」タグを作成しました`);
  }
  
  // 「録画処理済み」タグが存在するかチェック
  let processedLabel = GmailApp.getUserLabelByName(TAG_PROCESSED);
  if (!processedLabel) {
    processedLabel = GmailApp.createLabel(TAG_PROCESSED);
    console.log(`「${TAG_PROCESSED}」タグを作成しました`);
  }
  
  return { recordingLabel, processedLabel };
}

/**
 * Zoomからのメールを自動的に振り分けるフィルターを設定するための説明を表示
 */
function setupZoomEmailFilter() {
  const ui = SpreadsheetApp.getUi();
  
  const result = ui.alert(
    'メールフィルター設定',
    'Zoomからのクラウドレコーディングメールを「録画」タグに自動振り分けするフィルターを設定しますか？\n\n' +
    'これはGmailのフィルター機能を使って手動で設定する必要があります。手順を表示します。',
    ui.ButtonSet.YES_NO
  );
  
  if (result === ui.Button.YES) {
    const instructions = HtmlService.createHtmlOutput(`
      <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        h3 { color: #4285f4; }
        ol { margin-left: 20px; }
        li { margin-bottom: 10px; }
        .note { background-color: #f8f9fa; padding: 10px; border-left: 4px solid #4285f4; margin: 15px 0; }
      </style>
      <h2>Gmailフィルター設定手順</h2>
      
      <ol>
        <li>Gmailを開きます</li>
        <li>検索ボックスに「from:no-reply@zoom.us subject:クラウド レコーディング」と入力します</li>
        <li>検索ボックスの右側にある「検索オプションを表示」ボタン（▼）をクリックします</li>
        <li>「検索演算子に一致するメールを検索」の下に上記条件が表示されていることを確認します</li>
        <li>「フィルタを作成」ボタンをクリックします</li>
        <li>「ラベルを付ける」にチェックを入れ、「録画」を選択します（または「新しいラベル」から作成）</li>
        <li>「フィルタを作成」ボタンをクリックして完了します</li>
      </ol>
      
      <div class="note">
        <p><strong>注意:</strong> このフィルターは過去のメールには適用されません。過去のメールに適用したい場合は、手順3の検索結果画面で「このフィルタに一致するX件の会話にも適用する」にチェックを入れてください。</p>
      </div>
    `)
    .setWidth(600)
    .setHeight(400);
    
    ui.showModalDialog(instructions, 'Gmailフィルター設定手順');
  }
}

/**
 * メールが既に処理済みかどうかをチェック
 */
function isMessageProcessed(message) {
  const subject = message.getSubject();
  const date = message.getDate();
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(SHEET_NAME_RECORDINGS);
  
  // 全データを取得
  const data = sheet.getDataRange().getValues();
  
  // 日付と件名が一致するレコードがあるかチェック
  for (let i = 1; i < data.length; i++) {
    const rowDate = data[i][0]; // 日付列
    const rowName = data[i][1]; // 会議名列
    
    if (rowDate && rowName && subject.includes(rowName)) {
      const timeDiff = Math.abs(rowDate - date) / (1000 * 60); // 分単位の差
      if (timeDiff < 60) { // 1時間以内の差であれば同一とみなす
        return true;
      }
    }
  }
  
  return false;
}

/**
 * メールから録画情報を抽出
 */
function extractRecordingData(message) {
  const htmlBody = message.getBody();
  const subject = message.getSubject();
  const date = message.getDate();
  
  // 会議名を抽出（件名から「クラウド レコーディング - 」を除去）
  const meetingName = subject.replace("クラウド レコーディング - ", "").replace(" が利用可能になりました", "");
  
  // 正規表現でURLを抽出
  const urlMatch = htmlBody.match(/https:\/\/[^\s"<>]+zoom\.us\/rec\/share\/[^\s"<>]+/);
  const url = urlMatch ? urlMatch[0] : null;
  
  // 正規表現でパスワードを抽出
  const pwdMatch = htmlBody.match(/パスコード：\s*([A-Za-z0-9]+)/);
  const password = pwdMatch ? pwdMatch[1] : null;
  
  // 録画時間を抽出
  const durationMatch = htmlBody.match(/所要時間\s*(\d{2}:\d{2}:\d{2})/);
  const duration = durationMatch ? durationMatch[1] : null;
  
  if (!url || !password) {
    console.log("URLまたはパスワードを抽出できませんでした");
    return null;
  }
  
  return {
    date: date,
    meetingName: meetingName,
    duration: duration,
    url: url,
    password: password
  };
}

/**
 * addRecordingToSheet関数 - スプレッドシートに録画情報を追加
 */
function addRecordingToSheet(recordingData) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(SHEET_NAME_RECORDINGS);
  
  // 次の空き行を見つけて追加
  const nextRow = sheet.getLastRow() + 1;
  
  // データを入力
  sheet.getRange(nextRow, 1).setValue(recordingData.date);
  sheet.getRange(nextRow, 2).setValue(recordingData.meetingName);
  sheet.getRange(nextRow, 3).setValue(recordingData.duration);
  sheet.getRange(nextRow, 4).setValue(recordingData.url);
  sheet.getRange(nextRow, 5).setValue(recordingData.password);
  sheet.getRange(nextRow, 8).setValue("未処理");
  
  // 行全体の書式を調整
  sheet.getRange(nextRow, 1, 1, 9).setHorizontalAlignment("left");
  sheet.getRange(nextRow, 1, 1, 9).setBorder(true, true, true, true, true, true);
  
  // URLをハイパーリンクに設定
  sheet.getRange(nextRow, 4).setFormula(`=HYPERLINK("${recordingData.url}", "${recordingData.url}")`);
}

/**
 * 編集チーム向けDiscord通知を送信
 */
function notifyEditorsDiscord(recordingData) {
  const webhookUrl = PROPERTIES.getProperty('DISCORD_WEBHOOK_EDITORS');
  if (!webhookUrl) {
    console.error("Discord WebhookのURLが設定されていません");
    return;
  }
  
  // 絵文字を多用したメッセージ
  const message = {
    content: "🎬 **新しいZoom録画が利用可能になりました！** 🎉",
    embeds: [{
      title: `📹 ${recordingData.meetingName}`,
      color: 9442302, // 紫色
      fields: [
        {
          name: "📅 日時",
          value: Utilities.formatDate(recordingData.date, "Asia/Tokyo", "yyyy/MM/dd HH:mm"),
          inline: true
        },
        {
          name: "⏱️ 録画時間",
          value: recordingData.duration || "不明",
          inline: true
        },
        {
          name: "🔗 共有リンク",
          value: recordingData.url
        },
        {
          name: "🔑 パスワード",
          value: `\`${recordingData.password}\``
        }
      ],
      footer: {
        text: "✨ 編集後、スプレッドシートの処理状態を「編集済み」に変更し、Discord通知ボタンをクリックしてください ✨"
      }
    }]
  };
  
  const options = {
    method: "post",
    contentType: "application/json",
    payload: JSON.stringify(message)
  };
  
  try {
    const response = UrlFetchApp.fetch(webhookUrl, options);
    console.log(`Discord通知送信成功: ${response.getResponseCode()}`);
  } catch (error) {
    console.error(`Discord通知送信失敗: ${error.message}`);
  }
}

/**
 * 処理済みメールのタグを変更
 */
function changeMessageTag(message) {
  try {
    // メッセージからスレッドを取得
    const thread = message.getThread();
    
    // タグを変更
    thread.removeLabel(GmailApp.getUserLabelByName(TAG_RECORDING));
    
    // 処理済みタグが存在しない場合は作成
    let processedLabel = GmailApp.getUserLabelByName(TAG_PROCESSED);
    if (!processedLabel) {
      processedLabel = GmailApp.createLabel(TAG_PROCESSED);
    }
    
    thread.addLabel(processedLabel);
    
    console.log(`メールID: ${message.getId()} のタグを「${TAG_RECORDING}」から「${TAG_PROCESSED}」に変更しました`);
  } catch (error) {
    console.error(`タグ変更中にエラーが発生しました: ${error.message}`);
  }
}

/**
 * 録画処理済みのYouTube公開Discord通知
 * スプレッドシートのボタンクリックから呼び出される
 */
function sendYouTubeNotification(row) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName(SHEET_NAME_RECORDINGS);
    
    // 行データを取得
    const meetingName = sheet.getRange(row, 2).getValue();
    const youtubeUrl = sheet.getRange(row, 6).getValue();
    const description = sheet.getRange(row, 7).getValue();
    
    if (!youtubeUrl) {
      throw new Error("YouTube URLが入力されていません");
    }
    
    // Discord通知を送信
    notifyStudentsDiscord(meetingName, youtubeUrl, description);
    
    // 処理状態を更新
    sheet.getRange(row, 8).setValue("通知済み");
    sheet.getRange(row, 9).setValue("✓ 完了").setFontColor("green");
    
    // 処理履歴に記録
    logToHistory(
      meetingName,
      "YouTube通知",
      `URL: ${youtubeUrl}`
    );
    
    // 成功メッセージを表示（手動実行の場合のみ）
    if (ScriptApp.getTriggerId() === null) {
      SpreadsheetApp.getUi().alert("Discord通知が正常に送信されました");
    }
    
    return true;
  } catch (error) {
    console.error(`YouTube通知中にエラーが発生しました: ${error.message}`);
    
    // 処理履歴にエラーを記録
    logToHistory(
      "YouTube通知",
      "エラー",
      error.message
    );
    
    // 手動実行の場合、エラーを表示
    if (ScriptApp.getTriggerId() === null) {
      SpreadsheetApp.getUi().alert(`エラー: ${error.message}`);
    }
    
    throw error;
  }
}

/**
 * 受講者向けDiscord通知を送信
 */
function notifyStudentsDiscord(meetingName, youtubeUrl, description) {
  const webhookUrl = PROPERTIES.getProperty('DISCORD_WEBHOOK_STUDENTS');
  if (!webhookUrl) {
    throw new Error("受講者向けDiscord WebhookのURLが設定されていません");
  }
  
  // 絵文字を多用した受講者向けメッセージ
  const message = {
    content: "🌟 **新しい講義動画が公開されました！** 📚✨",
    embeds: [{
      title: `🎓 ${meetingName}`,
      url: youtubeUrl,
      color: 16711680, // 赤色
      description: description || "講義の動画が公開されました。ご視聴ください。💫",
      fields: [
        {
          name: "📺 YouTube URL",
          value: youtubeUrl
        }
      ],
      footer: {
        text: "❓ 質問がある場合は、コメント欄にお願いします 📝"
      }
    }]
  };
  
  const options = {
    method: "post",
    contentType: "application/json",
    payload: JSON.stringify(message)
  };
  
  try {
    const response = UrlFetchApp.fetch(webhookUrl, options);
    console.log(`Discord通知送信成功: ${response.getResponseCode()}`);
    return true;
  } catch (error) {
    console.error(`Discord通知送信失敗: ${error.message}`);
    throw error;
  }
}

/**
 * スプレッドシート編集時の処理（グローバルハンドラ）
 */
function onEdit(e) {
  try {
    // 通知ボタンがクリックされた場合の処理
    if (e.range.getColumn() === 9 && e.range.getValue() === "Discordに通知") {
      sendYouTubeNotification(e.range.getRow());
    }
    
    // 処理状態が「編集済み」に変更された場合、通知ボタンを追加
    if (e.range.getColumn() === 8 && e.range.getValue() === "編集済み") {
      const sheet = e.source.getActiveSheet();
      if (sheet.getName() === SHEET_NAME_RECORDINGS) {
        const row = e.range.getRow();
        
        // 通知ボタンをセットアップ
        sheet.getRange(row, 9).setValue("Discordに通知")
          .setFontColor("blue")
          .setFontWeight("bold")
          .setHorizontalAlignment("center")
          .setBackground("#e6f2ff");
      }
    }
  } catch (error) {
    console.error(`onEdit処理中にエラーが発生しました: ${error.message}`);
  }
}

---

