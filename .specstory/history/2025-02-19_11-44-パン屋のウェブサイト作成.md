<!-- Generated by SpecStory -->

# ãƒ‘ãƒ³å±‹ã®ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆä½œæˆ (2025-02-19 20:44:47)

_**User**_

ãƒ‘ãƒ³å±‹ã•ã‚“ã®ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã‚’ä½œã£ã¦ãã ã•ã„@index.html 

---

_**Assistant**_

Free & free trial accounts can no longer use chat with premium models on Cursor Version 0.45 or less. Please upgrade to Pro or use Cursor Version 0.46 or later. Install Cursor at https://www.cursor.com/downloads or update from within the editor.

---

_**User**_

ã‚¨ãƒ©ãƒ¼ä¿®æ­£ã—ã¦

/**
 * Zoomã®éŒ²ç”»ãƒ¡ãƒ¼ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆå®šæœŸå®Ÿè¡ŒãŠã‚ˆã³æ‰‹å‹•å®Ÿè¡Œç”¨ï¼‰
 */
function checkZoomEmails() {
  try {
    // ãƒ¡ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯ã®å‰ã«ã€å¿…è¦ãªã‚¿ã‚°ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèªã—ã€ãªã‘ã‚Œã°ä½œæˆ
    ensureGmailLabelsExist();
    
    // Zoomé€ä¿¡å…ƒã¨ãƒ¡ãƒ¼ãƒ«ä»¶åã‚’å–å¾—ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨ï¼‰
    const zoomSender = PROPERTIES.getProperty('ZOOM_SENDER') || 'no-reply@zoom.us';
    const zoomSubject = PROPERTIES.getProperty('ZOOM_SUBJECT') || 'ã‚¯ãƒ©ã‚¦ãƒ‰ ãƒ¬ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°';
    
    // ã€ŒéŒ²ç”»ã€ã‚¿ã‚°ä»˜ããƒ¡ãƒ¼ãƒ«ã‚’æ¤œç´¢
    const query = `label:${TAG_RECORDING} from:${zoomSender} subject:"${zoomSubject}"`;
    const threads = GmailApp.search(query, 0, 10); // æœ€æ–°10ä»¶ã¾ã§å‡¦ç†
    
    // æ‰‹å‹•å®Ÿè¡Œã®å ´åˆã€çµæœã‚’è¡¨ç¤º
    const isManualRun = ScriptApp.getTriggerId() === null;
    if (isManualRun && threads.length === 0) {
      SpreadsheetApp.getUi().alert('ãƒ¡ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯', 'æ–°ã—ã„éŒ²ç”»ãƒ¡ãƒ¼ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚', SpreadsheetApp.getUi().ButtonSet.OK);
      return;
    }
    
    console.log(`${threads.length}ä»¶ã®éŒ²ç”»ãƒ¡ãƒ¼ãƒ«ã‚’å‡¦ç†ã—ã¾ã™`);
    let processedCount = 0;
    
    for (const thread of threads) {
      const messages = thread.getMessages();
      
      for (const message of messages) {
        // å‡¦ç†æ¸ˆã¿ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆã‚¿ã‚°ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ï¼‰
        if (isMessageProcessed(message)) {
          console.log(`ãƒ¡ãƒ¼ãƒ«ID: ${message.getId()} ã¯æ—¢ã«å‡¦ç†æ¸ˆã¿ã§ã™`);
          continue;
        }
        
        // ãƒ¡ãƒ¼ãƒ«ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
        const recordingData = extractRecordingData(message);
        
        if (recordingData) {
          // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«æƒ…å ±ã‚’è¨˜éŒ²
          addRecordingToSheet(recordingData);
          
          // Discordé€šçŸ¥ã‚’é€ä¿¡
          notifyEditorsDiscord(recordingData);
          
          // ãƒ¡ãƒ¼ãƒ«ã®ã‚¿ã‚°ã‚’å¤‰æ›´
          changeMessageTag(message);
          
          // å‡¦ç†å±¥æ­´ã«è¨˜éŒ²
          logToHistory(
            message.getSubject(),
            "å‡¦ç†æˆåŠŸ",
            `URL: ${recordingData.url}, ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: ${recordingData.password}`
          );
          
          processedCount++;
          console.log(`ãƒ¡ãƒ¼ãƒ«ID: ${message.getId()} ã®å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸ`);
        } else {
          // å‡¦ç†å±¥æ­´ã«å¤±æ•—ã‚’è¨˜éŒ²
          logToHistory(
            message.getSubject(),
            "å‡¦ç†å¤±æ•—",
            "ãƒ‡ãƒ¼ã‚¿ã®æŠ½å‡ºã«å¤±æ•—ã—ã¾ã—ãŸ"
          );
          
          console.log(`ãƒ¡ãƒ¼ãƒ«ID: ${message.getId()} ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡ºã§ãã¾ã›ã‚“ã§ã—ãŸ`);
        }
      }
    }
    
    // æ‰‹å‹•å®Ÿè¡Œã®å ´åˆã€çµæœã‚’è¡¨ç¤º
    if (isManualRun) {
      SpreadsheetApp.getUi().alert(
        'ãƒ¡ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯', 
        `${processedCount}ä»¶ã®æ–°ã—ã„éŒ²ç”»ãƒ¡ãƒ¼ãƒ«ã‚’å‡¦ç†ã—ã¾ã—ãŸã€‚`, 
        SpreadsheetApp.getUi().ButtonSet.OK
      );
    }
  } catch (error) {
    console.error(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
    
    // å‡¦ç†å±¥æ­´ã«ã‚¨ãƒ©ãƒ¼ã‚’è¨˜éŒ²
    logToHistory(
      "ã‚·ã‚¹ãƒ†ãƒ ",
      "ã‚¨ãƒ©ãƒ¼",
      `ãƒ¡ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ: ${error.message}`
    );
    
    // æ‰‹å‹•å®Ÿè¡Œã®å ´åˆã€ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤º
    if (ScriptApp.getTriggerId() === null) {
      SpreadsheetApp.getUi().alert('ã‚¨ãƒ©ãƒ¼', `ãƒ¡ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`, SpreadsheetApp.getUi().ButtonSet.OK);
    }
  }
}/**
 * ãƒ¡ãƒ¼ãƒ«å‡¦ç†ã®å±¥æ­´ã‚’è¡¨ç¤º
 */
function viewProcessingHistory() {
  const ui = SpreadsheetApp.getUi();
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  
  // å±¥æ­´ã‚·ãƒ¼ãƒˆã®å­˜åœ¨ç¢ºèªã¨ä½œæˆ
  let historySheet = ss.getSheetByName("å‡¦ç†å±¥æ­´");
  if (!historySheet) {
    historySheet = ss.insertSheet("å‡¦ç†å±¥æ­´");
    historySheet.getRange("A1:D1").setValues([["å‡¦ç†æ—¥æ™‚", "ãƒ¡ãƒ¼ãƒ«ä»¶å", "å‡¦ç†çµæœ", "è©³ç´°"]]);
    historySheet.getRange("A1:D1").setFontWeight("bold");
    historySheet.setFrozenRows(1);
    historySheet.setColumnWidth(1, 150);
    historySheet.setColumnWidth(2, 300);
    historySheet.setColumnWidth(3, 100);
    historySheet.setColumnWidth(4, 400);
  }
  
  // è¡¨ç¤º
  const html = HtmlService.createHtmlOutput(`
    <style>
      body { font-family: Arial, sans-serif; margin: 20px; }
      h2 { color: #4285f4; }
      p { margin-bottom: 20px; }
      button { margin-top: 10px; padding: 8px 15px; background-color: #4285f4; color: white; border: none; border-radius: 3px; cursor: pointer; }
    </style>
    <h2>ãƒ¡ãƒ¼ãƒ«å‡¦ç†å±¥æ­´</h2>
    <p>ãƒ¡ãƒ¼ãƒ«å‡¦ç†ã®å±¥æ­´ã¯ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ã€Œå‡¦ç†å±¥æ­´ã€ã‚·ãƒ¼ãƒˆã«è¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚</p>
    <button onclick="clearHistory()">å±¥æ­´ã‚’ã‚¯ãƒªã‚¢</button>
    <button onclick="google.script.host.close()">é–‰ã˜ã‚‹</button>
    
    <script>
      function clearHistory() {
        if (confirm('å‡¦ç†å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) {
          google.script.run
            .withSuccessHandler(() => {
              alert('å±¥æ­´ãŒã‚¯ãƒªã‚¢ã•ã‚Œã¾ã—ãŸ');
            })
            .clearProcessingHistory();
        }
      }
    </script>
  `)
  .setWidth(400)
  .setHeight(250);
  
  ui.showModalDialog(html, 'å‡¦ç†å±¥æ­´');
}

/**
 * å‡¦ç†å±¥æ­´ã‚’ã‚¯ãƒªã‚¢
 */
function clearProcessingHistory() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const historySheet = ss.getSheetByName("å‡¦ç†å±¥æ­´");
  
  if (historySheet) {
    // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ä¿æŒã—ã€ãã‚Œä»¥å¤–ã‚’ã‚¯ãƒªã‚¢
    const lastRow = historySheet.getLastRow();
    if (lastRow > 1) {
      historySheet.getRange(2, 1, lastRow - 1, 4).clearContent();
    }
  }
}

/**
 * å‡¦ç†å±¥æ­´ã«è¨˜éŒ²
 */
function logToHistory(subject, result, details) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let historySheet = ss.getSheetByName("å‡¦ç†å±¥æ­´");
  
  if (!historySheet) {
    historySheet = ss.insertSheet("å‡¦ç†å±¥æ­´");
    historySheet.getRange("A1:D1").setValues([["å‡¦ç†æ—¥æ™‚", "ãƒ¡ãƒ¼ãƒ«ä»¶å", "å‡¦ç†çµæœ", "è©³ç´°"]]);
    historySheet.getRange("A1:D1").setFontWeight("bold");
    historySheet.setFrozenRows(1);
  }
  
  const now = new Date();
  const timestamp = Utilities.formatDate(now, "Asia/Tokyo", "yyyy/MM/dd HH:mm:ss");
  
  // æ–°ã—ã„è¡Œã‚’è¿½åŠ 
  const nextRow = historySheet.getLastRow() + 1;
  historySheet.getRange(nextRow, 1).setValue(timestamp);
  historySheet.getRange(nextRow, 2).setValue(subject);
  historySheet.getRange(nextRow, 3).setValue(result);
  historySheet.getRange(nextRow, 4).setValue(details);
}

/**
 * æ‰‹å‹•ã§ZoomãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°æƒ…å ±ã‚’è¿½åŠ ã™ã‚‹ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
 */
function showAddMeetingDialog() {
  const html = HtmlService.createHtmlOutput(`
    <style>
      body { font-family: Arial, sans-serif; margin: 20px; }
      h2 { color: #4285f4; }
      label { display: block; margin-top: 15px; font-weight: bold; }
      input, textarea { width: 100%; padding: 8px; margin-top: 5px; }
      button { margin-top: 20px; padding: 10px; background-color: #4285f4; color: white; border: none; border-radius: 5px; cursor: pointer; }
    </style>
    <h2>ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°æƒ…å ±ã®æ‰‹å‹•è¿½åŠ </h2>
    <form id="meetingForm">
      <label for="meetingName">ä¼šè­°å:</label>
      <input type="text" id="meetingName" name="meetingName" required>
      
      <label for="meetingDate">æ—¥æ™‚:</label>
      <input type="datetime-local" id="meetingDate" name="meetingDate" required>
      
      <label for="duration">éŒ²ç”»æ™‚é–“ (HH:MM:SS):</label>
      <input type="text" id="duration" name="duration" pattern="\\d{2}:\\d{2}:\\d{2}" placeholder="01:30:00" required>
      
      <label for="recordingUrl">éŒ²ç”»URL:</label>
      <input type="url" id="recordingUrl" name="recordingUrl" required>
      
      <label for="password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:</label>
      <input type="text" id="password" name="password" required>
      
      <button type="button" onclick="submitForm()">è¿½åŠ </button>
    </form>
    
    <script>
      // ç¾åœ¨ã®æ—¥æ™‚ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§è¨­å®š
      document.addEventListener('DOMContentLoaded', function() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        
        document.getElementById('meetingDate').value = `${year}-${month}-${day}T${hours}:${minutes}`;
      });
      
      function submitForm() {
        const form = document.getElementById('meetingForm');
        
        // ç°¡æ˜“ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        if (!form.checkValidity()) {
          alert('ã™ã¹ã¦ã®é …ç›®ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„');
          return;
        }
        
        // ãƒ‡ãƒ¼ã‚¿åé›†
        const meetingData = {
          meetingName: form.elements.meetingName.value,
          meetingDate: form.elements.meetingDate.value,
          duration: form.elements.duration.value,
          recordingUrl: form.elements.recordingUrl.value,
          password: form.elements.password.value
        };
        
        // ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡
        google.script.run
          .withSuccessHandler(function() {
            alert('ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°æƒ…å ±ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸ');
            google.script.host.close();
          })
          .withFailureHandler(function(error) {
            alert('ã‚¨ãƒ©ãƒ¼: ' + error);
          })
          .addMeetingManually(meetingData);
      }
    </script>
  `)
  .setWidth(500)
  .setHeight(550);
  
  SpreadsheetApp.getUi().showModalDialog(html, 'ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°æƒ…å ±ã®æ‰‹å‹•è¿½åŠ ');
}

/**
 * æ‰‹å‹•ã§ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°æƒ…å ±ã‚’è¿½åŠ 
 */
function addMeetingManually(meetingData) {
  try {
    // æ—¥æ™‚æ–‡å­—åˆ—ã‚’Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›
    const meetingDate = new Date(meetingData.meetingDate);
    
    // éŒ²ç”»ãƒ‡ãƒ¼ã‚¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
    const recordingData = {
      date: meetingDate,
      meetingName: meetingData.meetingName,
      duration: meetingData.duration,
      url: meetingData.recordingUrl,
      password: meetingData.password
    };
    
    // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«æƒ…å ±ã‚’è¨˜éŒ²
    addRecordingToSheet(recordingData);
    
    // Discordé€šçŸ¥ã‚’é€ä¿¡ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
    const ui = SpreadsheetApp.getUi();
    const sendNotification = ui.alert(
      'é€šçŸ¥ç¢ºèª',
      'ç·¨é›†ãƒãƒ¼ãƒ ã«Discordé€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ',
      ui.ButtonSet.YES_NO
    );
    
    if (sendNotification === ui.Button.YES) {
      notifyEditorsDiscord(recordingData);
    }
    
    // å‡¦ç†å±¥æ­´ã«è¨˜éŒ²
    logToHistory(
      meetingData.meetingName,
      "æ‰‹å‹•è¿½åŠ ",
      `URL: ${meetingData.recordingUrl}, ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: ${meetingData.password}`
    );
    
    return true;
  } catch (error) {
    console.error(`æ‰‹å‹•è¿½åŠ ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
    throw error;
  }
}/**
 * è‡ªå‹•å‡¦ç†ã•ã‚ŒãŸZoomã®éŒ²ç”»ãƒ¡ãƒ¼ãƒ«ã‚’æ‰‹å‹•ã§ç¢ºèªã™ã‚‹
 */
function viewProcessedEmails() {
  const ui = SpreadsheetApp.getUi();
  
  // å‡¦ç†æ¸ˆã¿ãƒ¡ãƒ¼ãƒ«ã®æ¤œç´¢
  const query = `label:${TAG_PROCESSED} from:no-reply@zoom.us subject:"ã‚¯ãƒ©ã‚¦ãƒ‰ ãƒ¬ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°"`;
  const threads = GmailApp.search(query, 0, 10); // æœ€æ–°10ä»¶ã¾ã§
  
  if (threads.length === 0) {
    ui.alert('æƒ…å ±', 'å‡¦ç†æ¸ˆã¿ã®ZooméŒ²ç”»ãƒ¡ãƒ¼ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“ã€‚', ui.ButtonSet.OK);
    return;
  }
  
  // å‡¦ç†æ¸ˆã¿ãƒ¡ãƒ¼ãƒ«ã®ä¸€è¦§ã‚’è¡¨ç¤º
  let html = `
    <style>
      body { font-family: Arial, sans-serif; margin: 20px; }
      h2 { color: #4285f4; }
      table { width: 100%; border-collapse: collapse; margin-top: 20px; }
      th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
      th { background-color: #f2f2f2; }
      tr:hover { background-color: #f5f5f5; }
      .date { width: 150px; }
      .subject { width: 350px; }
      .actions { width: 100px; text-align: center; }
      button { padding: 5px 10px; background-color: #4285f4; color: white; border: none; border-radius: 3px; cursor: pointer; }
    </style>
    <h2>å‡¦ç†æ¸ˆã¿ZooméŒ²ç”»ãƒ¡ãƒ¼ãƒ«</h2>
    <table>
      <tr>
        <th class="date">æ—¥ä»˜</th>
        <th class="subject">ä»¶å</th>
        <th class="actions">æ“ä½œ</th>
      </tr>
  `;
  
  for (let i = 0; i < threads.length; i++) {
    const thread = threads[i];
    const message = thread.getMessages()[0]; // æœ€åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    const date = Utilities.formatDate(message.getDate(), "Asia/Tokyo", "yyyy/MM/dd HH:mm");
    const subject = message.getSubject();
    
    html += `
      <tr>
        <td class="date">${date}</td>
        <td class="subject">${subject}</td>
        <td class="actions">
          <button onclick="viewEmail(${i})">è©³ç´°</button>
        </td>
      </tr>
    `;
  }
  
  html += `
    </table>
    <script>
      function viewEmail(index) {
        google.script.run.viewEmailDetails(index);
      }
    </script>
  `;
  
  const htmlOutput = HtmlService.createHtmlOutput(html)
    .setWidth(600)
    .setHeight(400);
  
  ui.showModalDialog(htmlOutput, 'å‡¦ç†æ¸ˆã¿ãƒ¡ãƒ¼ãƒ«ä¸€è¦§');
  
  // ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«ä¸€æ™‚çš„ã«ã‚¹ãƒ¬ãƒƒãƒ‰IDã‚’ä¿å­˜
  const threadIds = threads.map(thread => thread.getId());
  PROPERTIES.setProperty('TEMP_THREAD_IDS', JSON.stringify(threadIds));
}

/**
 * æŒ‡å®šã•ã‚ŒãŸã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ãƒ¡ãƒ¼ãƒ«è©³ç´°ã‚’è¡¨ç¤º
 */
function viewEmailDetails(index) {
  const threadIdsStr = PROPERTIES.getProperty('TEMP_THREAD_IDS');
  if (!threadIdsStr) return;
  
  const threadIds = JSON.parse(threadIdsStr);
  if (index >= threadIds.length) return;
  
  const threadId = threadIds[index];
  const thread = GmailApp.getThreadById(threadId);
  const message = thread.getMessages()[0];
  
  const subject = message.getSubject();
  const date = Utilities.formatDate(message.getDate(), "Asia/Tokyo", "yyyy/MM/dd HH:mm");
  const sender = message.getFrom();
  const body = message.getBody();
  
  const html = `
    <style>
      body { font-family: Arial, sans-serif; margin: 20px; }
      h2 { color: #4285f4; }
      .meta { margin-bottom: 20px; }
      .meta div { margin-bottom: 5px; }
      .label { font-weight: bold; display: inline-block; width: 100px; }
      .content { border: 1px solid #ddd; padding: 15px; background-color: #f9f9f9; }
      button { margin-top: 20px; padding: 8px 15px; background-color: #4285f4; color: white; border: none; border-radius: 3px; cursor: pointer; }
    </style>
    <h2>ãƒ¡ãƒ¼ãƒ«è©³ç´°</h2>
    <div class="meta">
      <div><span class="label">ä»¶å:</span> ${subject}</div>
      <div><span class="label">æ—¥æ™‚:</span> ${date}</div>
      <div><span class="label">é€ä¿¡è€…:</span> ${sender}</div>
    </div>
    <div class="content">${body}</div>
    <button onclick="reprocess()">å†å‡¦ç†ã™ã‚‹</button>
    <button onclick="goBack()">æˆ»ã‚‹</button>
    
    <script>
      function reprocess() {
        if (confirm('ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚’å†å‡¦ç†ã—ã¾ã™ã‹ï¼Ÿ')) {
          google.script.run
            .withSuccessHandler(() => {
              google.script.host.close();
            })
            .reprocessEmail(${index});
        }
      }
      
      function goBack() {
        google.script.run.viewProcessedEmails();
      }
    </script>
  `;
  
  const htmlOutput = HtmlService.createHtmlOutput(html)
    .setWidth(700)
    .setHeight(500);
  
  SpreadsheetApp.getUi().showModalDialog(htmlOutput, 'ãƒ¡ãƒ¼ãƒ«è©³ç´°');
}

/**
 * æŒ‡å®šã•ã‚ŒãŸãƒ¡ãƒ¼ãƒ«ã‚’å†å‡¦ç†ã™ã‚‹
 */
function reprocessEmail(index) {
  const threadIdsStr = PROPERTIES.getProperty('TEMP_THREAD_IDS');
  if (!threadIdsStr) return;
  
  const threadIds = JSON.parse(threadIdsStr);
  if (index >= threadIds.length) return;
  
  try {
    const threadId = threadIds[index];
    const thread = GmailApp.getThreadById(threadId);
    const message = thread.getMessages()[0];
    
    // ã‚¿ã‚°ã‚’å¤‰æ›´
    thread.removeLabel(GmailApp.getUserLabelByName(TAG_PROCESSED));
    thread.addLabel(GmailApp.getUserLabelByName(TAG_RECORDING));
    
    // å†å‡¦ç†ã‚’ãƒˆãƒªã‚¬ãƒ¼
    checkZoomEmails();
    
    SpreadsheetApp.getUi().alert('å®Œäº†', 'ãƒ¡ãƒ¼ãƒ«ã‚’å†å‡¦ç†ã—ã¾ã—ãŸã€‚', SpreadsheetApp.getUi().ButtonSet.OK);
  } catch (error) {
    SpreadsheetApp.getUi().alert('ã‚¨ãƒ©ãƒ¼', `å†å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`, SpreadsheetApp.getUi().ButtonSet.OK);
  }
}/**
 * ZooméŒ²ç”»è‡ªå‹•å‡¦ç†ã‚·ã‚¹ãƒ†ãƒ 
 * 
 * ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ä»¥ä¸‹ã®æ©Ÿèƒ½ã‚’æä¾›ã—ã¾ã™ï¼š
 * 1. Gmailã‹ã‚‰ã€ŒéŒ²ç”»ã€ã‚¿ã‚°ä»˜ããƒ¡ãƒ¼ãƒ«ã‚’å®šæœŸçš„ã«æ¤œç´¢
 * 2. ãƒ¡ãƒ¼ãƒ«ã‹ã‚‰ZooméŒ²ç”»ã®URLã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æŠ½å‡º
 * 3. æƒ…å ±ã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è¨˜éŒ²
 * 4. Discord Webhookã§Discordã«é€šçŸ¥
 * 5. å‡¦ç†æ¸ˆã¿ãƒ¡ãƒ¼ãƒ«ã®ã‚¿ã‚°ã‚’å¤‰æ›´
 * 6. YouTubeã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¾Œã®é€šçŸ¥ãƒœã‚¿ãƒ³æ©Ÿèƒ½
 */

// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
const PROPERTIES = PropertiesService.getScriptProperties();
const SHEET_NAME_RECORDINGS = "éŒ²ç”»ç®¡ç†";
const SHEET_NAME_SETTINGS = "è¨­å®š";
const TAG_RECORDING = "éŒ²ç”»";
const TAG_PROCESSED = "éŒ²ç”»å‡¦ç†æ¸ˆã¿";

/**
 * ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¿½åŠ ã™ã‚‹ãŸã‚ã®onOpené–¢æ•°
 */
function onOpen() {
  // ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¿½åŠ 
  const ui = SpreadsheetApp.getUi();
  ui.createMenu('ZooméŒ²ç”»ç®¡ç†')
    .addItem('ã‚·ã‚¹ãƒ†ãƒ è¨­å®š', 'showSettingsDialog')
    .addItem('Webhookè¨­å®š', 'showWebhookSettingsDialog')
    .addItem('ãƒˆãƒªã‚¬ãƒ¼è¨­å®š', 'setupTriggers')
    .addItem('æ‰‹å‹•ã§ãƒ¡ãƒ¼ãƒ«ç¢ºèª', 'checkZoomEmails')
    .addItem('æ‰‹å‹•ã§å—è¬›ç”Ÿã«é€šçŸ¥', 'manuallyNotifyStudents')
    .addItem('æ‰‹å‹•ã§éŒ²ç”»æƒ…å ±ã‚’è¿½åŠ ', 'showAddMeetingDialog')
    .addItem('å‡¦ç†æ¸ˆã¿ãƒ¡ãƒ¼ãƒ«ã‚’è¡¨ç¤º', 'viewProcessedEmails')
    .addItem('å‡¦ç†å±¥æ­´ã‚’è¡¨ç¤º', 'viewProcessingHistory')
    .addItem('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆåˆæœŸåŒ–', 'initializeSpreadsheet')
    .addToUi();
  
  // è¨­å®šãŒæœªå®Œäº†ã®å ´åˆã¯è¨­å®šãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
  if (!areSettingsComplete()) {
    showSettingsDialog();
  }
}

/**
 * è¨­å®šãŒå®Œäº†ã—ã¦ã„ã‚‹ã‹ã‚’ãƒã‚§ãƒƒã‚¯
 */
function areSettingsComplete() {
  const editorsWebhook = PROPERTIES.getProperty('DISCORD_WEBHOOK_EDITORS');
  const studentsWebhook = PROPERTIES.getProperty('DISCORD_WEBHOOK_STUDENTS');
  return editorsWebhook && studentsWebhook;
}

/**
 * ã‚·ã‚¹ãƒ†ãƒ è¨­å®šãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
 */
function showSettingsDialog() {
  const html = HtmlService.createHtmlOutput(`
    <style>
      body { font-family: Arial, sans-serif; margin: 20px; }
      label { display: block; margin-top: 15px; font-weight: bold; }
      input { width: 100%; padding: 5px; margin-top: 5px; }
      button { margin-top: 20px; padding: 10px; background-color: #4285f4; color: white; border: none; border-radius: 5px; }
      .tabs { display: flex; margin-bottom: 20px; }
      .tab { padding: 10px 15px; cursor: pointer; border: 1px solid #ccc; border-bottom: none; }
      .tab.active { background-color: #f0f0f0; }
      .tab-content { display: none; }
      .tab-content.active { display: block; }
    </style>
    <h2>ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</h2>
    
    <div class="tabs">
      <div class="tab active" onclick="showTab('general')">ä¸€èˆ¬è¨­å®š</div>
      <div class="tab" onclick="showTab('email')">ãƒ¡ãƒ¼ãƒ«è¨­å®š</div>
      <div class="tab" onclick="showTab('discord')">Discordè¨­å®š</div>
    </div>
    
    <form id="settingsForm">
      <div id="general" class="tab-content active">
        <label for="checkInterval">ãƒ¡ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯é–“éš”ï¼ˆåˆ†ï¼‰:</label>
        <input type="number" id="checkInterval" name="checkInterval" min="5" max="60" value="${PROPERTIES.getProperty('CHECK_INTERVAL') || '15'}">
        
        <label for="webhookCheckInterval">Webhookç¢ºèªé–“éš”ï¼ˆæ™‚é–“ï¼‰:</label>
        <input type="number" id="webhookCheckInterval" name="webhookCheckInterval" min="1" max="24" value="${PROPERTIES.getProperty('WEBHOOK_CHECK_INTERVAL') || '12'}">
      </div>
      
      <div id="email" class="tab-content">
        <label for="zoomSender">Zoomé€ä¿¡å…ƒãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹:</label>
        <input type="text" id="zoomSender" name="zoomSender" value="${PROPERTIES.getProperty('ZOOM_SENDER') || 'no-reply@zoom.us'}">
        
        <label for="zoomSubject">ZooméŒ²ç”»ãƒ¡ãƒ¼ãƒ«ã®ä»¶åã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰:</label>
        <input type="text" id="zoomSubject" name="zoomSubject" value="${PROPERTIES.getProperty('ZOOM_SUBJECT') || 'ã‚¯ãƒ©ã‚¦ãƒ‰ ãƒ¬ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°'}">
        
        <button type="button" onclick="setupEmailFilter()">Gmailãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’è¨­å®š</button>
      </div>
      
      <div id="discord" class="tab-content">
        <label for="editorsWebhook">ç·¨é›†ãƒãƒ¼ãƒ å‘ã‘ Discord Webhook URL:</label>
        <input type="text" id="editorsWebhook" name="editorsWebhook" value="${PROPERTIES.getProperty('DISCORD_WEBHOOK_EDITORS') || ''}">
        
        <label for="studentsWebhook">å—è¬›è€…å‘ã‘ Discord Webhook URL:</label>
        <input type="text" id="studentsWebhook" name="studentsWebhook" value="${PROPERTIES.getProperty('DISCORD_WEBHOOK_STUDENTS') || ''}">
        
        <button type="button" onclick="testWebhooks()">Webhookã‚’ãƒ†ã‚¹ãƒˆ</button>
      </div>
      
      <button type="button" onclick="saveAllSettings()" style="margin-top: 30px;">ã™ã¹ã¦ã®è¨­å®šã‚’ä¿å­˜</button>
    </form>
    
    <script>
      function showTab(tabId) {
        // ã™ã¹ã¦ã®ã‚¿ãƒ–ã¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        
        // é¸æŠã—ãŸã‚¿ãƒ–ã¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
        document.querySelector('.tab[onclick*="' + tabId + '"]').classList.add('active');
        document.getElementById(tabId).classList.add('active');
      }
      
      function saveAllSettings() {
        const form = document.getElementById('settingsForm');
        const settings = {
          checkInterval: form.elements.checkInterval.value,
          webhookCheckInterval: form.elements.webhookCheckInterval.value,
          zoomSender: form.elements.zoomSender.value,
          zoomSubject: form.elements.zoomSubject.value,
          editorsWebhook: form.elements.editorsWebhook.value,
          studentsWebhook: form.elements.studentsWebhook.value
        };
        
        google.script.run
          .withSuccessHandler(() => {
            google.script.host.close();
          })
          .saveAllSettings(settings);
      }
      
      function setupEmailFilter() {
        google.script.run.setupZoomEmailFilter();
      }
      
      function testWebhooks() {
        const editorsWebhook = document.getElementById('editorsWebhook').value;
        const studentsWebhook = document.getElementById('studentsWebhook').value;
        
        google.script.run
          .withSuccessHandler(result => {
            alert(result);
          })
          .testDiscordWebhooks(editorsWebhook, studentsWebhook);
      }
    </script>
  `)
  .setWidth(600)
  .setHeight(500);
  
  SpreadsheetApp.getUi().showModalDialog(html, 'ã‚·ã‚¹ãƒ†ãƒ è¨­å®š');
}

/**
 * Webhookè¨­å®šãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
 */
function showWebhookSettingsDialog() {
  const html = HtmlService.createHtmlOutput(`
    <style>
      body { font-family: Arial, sans-serif; margin: 20px; }
      h3 { color: #4285f4; margin-top: 20px; }
      label { display: block; margin-top: 15px; font-weight: bold; }
      input { width: 100%; padding: 5px; margin-top: 5px; }
      button { margin-top: 20px; padding: 10px; background-color: #4285f4; color: white; border: none; border-radius: 5px; }
      .status { margin-top: 10px; padding: 8px; border-radius: 4px; }
      .status.valid { background-color: #d4edda; color: #155724; }
      .status.invalid { background-color: #f8d7da; color: #721c24; }
    </style>
    <h2>Discord Webhookè¨­å®š</h2>
    
    <form id="webhookForm">
      <h3>ç·¨é›†ãƒãƒ¼ãƒ å‘ã‘ Webhook</h3>
      <label for="editorsWebhook">Webhook URL:</label>
      <input type="text" id="editorsWebhook" name="editorsWebhook" value="${PROPERTIES.getProperty('DISCORD_WEBHOOK_EDITORS') || ''}">
      <div id="editorsStatus" class="status"></div>
      
      <h3>å—è¬›è€…å‘ã‘ Webhook</h3>
      <label for="studentsWebhook">Webhook URL:</label>
      <input type="text" id="studentsWebhook" name="studentsWebhook" value="${PROPERTIES.getProperty('DISCORD_WEBHOOK_STUDENTS') || ''}">
      <div id="studentsStatus" class="status"></div>
      
      <button type="button" onclick="validateWebhooks()">Webhookã‚’æ¤œè¨¼</button>
      <button type="button" onclick="saveWebhooks()">ä¿å­˜</button>
    </form>
    
    <script>
      function validateWebhooks() {
        const editorsWebhook = document.getElementById('editorsWebhook').value;
        const studentsWebhook = document.getElementById('studentsWebhook').value;
        
        // ç·¨é›†è€…å‘ã‘Webhookã®æ¤œè¨¼
        if (editorsWebhook) {
          document.getElementById('editorsStatus').textContent = 'æ¤œè¨¼ä¸­...';
          document.getElementById('editorsStatus').className = 'status';
          
          google.script.run
            .withSuccessHandler(result => {
              const status = document.getElementById('editorsStatus');
              if (result === 'valid') {
                status.textContent = 'âœ“ æœ‰åŠ¹ãªWebhookã§ã™';
                status.className = 'status valid';
              } else {
                status.textContent = 'âœ— ç„¡åŠ¹ãªWebhook: ' + result;
                status.className = 'status invalid';
              }
            })
            .validateWebhook(editorsWebhook);
        }
        
        // å—è¬›è€…å‘ã‘Webhookã®æ¤œè¨¼
        if (studentsWebhook) {
          document.getElementById('studentsStatus').textContent = 'æ¤œè¨¼ä¸­...';
          document.getElementById('studentsStatus').className = 'status';
          
          google.script.run
            .withSuccessHandler(result => {
              const status = document.getElementById('studentsStatus');
              if (result === 'valid') {
                status.textContent = 'âœ“ æœ‰åŠ¹ãªWebhookã§ã™';
                status.className = 'status valid';
              } else {
                status.textContent = 'âœ— ç„¡åŠ¹ãªWebhook: ' + result;
                status.className = 'status invalid';
              }
            })
            .validateWebhook(studentsWebhook);
        }
      }
      
      function saveWebhooks() {
        const form = document.getElementById('webhookForm');
        const editorsWebhook = form.elements.editorsWebhook.value;
        const studentsWebhook = form.elements.studentsWebhook.value;
        
        google.script.run
          .withSuccessHandler(() => {
            google.script.host.close();
          })
          .saveSettings(editorsWebhook, studentsWebhook);
      }
    </script>
  `)
  .setWidth(600)
  .setHeight(450);
  
  SpreadsheetApp.getUi().showModalDialog(html, 'Discord Webhookè¨­å®š');
}

/**
 * è¨­å®šã‚’ä¿å­˜
 */
function saveSettings(editorsWebhook, studentsWebhook) {
  PROPERTIES.setProperty('DISCORD_WEBHOOK_EDITORS', editorsWebhook);
  PROPERTIES.setProperty('DISCORD_WEBHOOK_STUDENTS', studentsWebhook);
  
  // å¿…è¦ã«å¿œã˜ã¦ã‚·ãƒ¼ãƒˆæ§‹é€ ã‚’åˆæœŸåŒ–
  initializeSpreadsheet();
  
  // å®šæœŸå®Ÿè¡Œãƒˆãƒªã‚¬ãƒ¼ãŒãªã‘ã‚Œã°è¨­å®š
  setTriggerIfNeeded();
}

/**
 * ã™ã¹ã¦ã®è¨­å®šã‚’ä¿å­˜
 */
function saveAllSettings(settings) {
  // ä¸€èˆ¬è¨­å®š
  PROPERTIES.setProperty('CHECK_INTERVAL', settings.checkInterval);
  PROPERTIES.setProperty('WEBHOOK_CHECK_INTERVAL', settings.webhookCheckInterval);
  
  // ãƒ¡ãƒ¼ãƒ«è¨­å®š
  PROPERTIES.setProperty('ZOOM_SENDER', settings.zoomSender);
  PROPERTIES.setProperty('ZOOM_SUBJECT', settings.zoomSubject);
  
  // Discordè¨­å®š
  PROPERTIES.setProperty('DISCORD_WEBHOOK_EDITORS', settings.editorsWebhook);
  PROPERTIES.setProperty('DISCORD_WEBHOOK_STUDENTS', settings.studentsWebhook);
  
  // è¨­å®šã‚·ãƒ¼ãƒˆã‚’æ›´æ–°
  updateSettingsSheet();
  
  // å¿…è¦ã«å¿œã˜ã¦ã‚·ãƒ¼ãƒˆæ§‹é€ ã‚’åˆæœŸåŒ–
  initializeSpreadsheet();
  
  // ãƒˆãƒªã‚¬ãƒ¼ã‚’æ›´æ–°
  updateTriggers();
  
  // å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  SpreadsheetApp.getUi().alert('è¨­å®šã®ä¿å­˜', 'è¨­å®šãŒä¿å­˜ã•ã‚Œã¾ã—ãŸã€‚', SpreadsheetApp.getUi().ButtonSet.OK);
}

/**
 * è¨­å®šã‚·ãƒ¼ãƒˆã®å†…å®¹ã‚’æ›´æ–°
 */
function updateSettingsSheet() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const settingsSheet = ss.getSheetByName(SHEET_NAME_SETTINGS);
  
  if (!settingsSheet) return;
  
  // ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‹ã‚‰å€¤ã‚’è¨­å®š
  settingsSheet.getRange("B2").setValue(PROPERTIES.getProperty('DISCORD_WEBHOOK_EDITORS') || '');
  settingsSheet.getRange("B3").setValue(PROPERTIES.getProperty('DISCORD_WEBHOOK_STUDENTS') || '');
  settingsSheet.getRange("B4").setValue(PROPERTIES.getProperty('WEBHOOK_CHECK_INTERVAL') || '12');
}

/**
 * ãƒˆãƒªã‚¬ãƒ¼ã‚’è¨­å®šé–“éš”ã«åˆã‚ã›ã¦æ›´æ–°
 */
function updateTriggers() {
  // æ—¢å­˜ã®ãƒˆãƒªã‚¬ãƒ¼ã‚’å‰Šé™¤
  const triggers = ScriptApp.getProjectTriggers();
  for (const trigger of triggers) {
    if (trigger.getHandlerFunction() === 'checkZoomEmails' || 
        trigger.getHandlerFunction() === 'checkWebhookStatus') {
      ScriptApp.deleteTrigger(trigger);
    }
  }
  
  // ãƒ¡ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯ãƒˆãƒªã‚¬ãƒ¼ã‚’è¨­å®š
  const checkInterval = Number(PROPERTIES.getProperty('CHECK_INTERVAL')) || 15;
  ScriptApp.newTrigger('checkZoomEmails')
    .timeBased()
    .everyMinutes(checkInterval)
    .create();
  
  // Webhookç¢ºèªãƒˆãƒªã‚¬ãƒ¼ã‚’è¨­å®š
  const webhookCheckInterval = Number(PROPERTIES.getProperty('WEBHOOK_CHECK_INTERVAL')) || 12;
  ScriptApp.newTrigger('checkWebhookStatus')
    .timeBased()
    .everyHours(webhookCheckInterval)
    .create();
}

/**
 * Discord Webhookã®æœ‰åŠ¹æ€§ã‚’æ¤œè¨¼
 */
function validateWebhook(webhookUrl) {
  if (!webhookUrl) return 'URLãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“';
  
  try {
    const options = {
      method: 'get',
      muteHttpExceptions: true
    };
    
    const response = UrlFetchApp.fetch(webhookUrl, options);
    const code = response.getResponseCode();
    
    if (code === 200) {
      return 'valid';
    } else {
      return `HTTPã‚¨ãƒ©ãƒ¼: ${code}`;
    }
  } catch (error) {
    return `ã‚¨ãƒ©ãƒ¼: ${error.message}`;
  }
}

/**
 * Discord Webhookã‚’ãƒ†ã‚¹ãƒˆ
 */
function testDiscordWebhooks(editorsWebhook, studentsWebhook) {
  let results = '';
  
  // ç·¨é›†ãƒãƒ¼ãƒ å‘ã‘Webhookã®ãƒ†ã‚¹ãƒˆ
  if (editorsWebhook) {
    try {
      const message = {
        content: "ğŸ§ª **Webhook ãƒ†ã‚¹ãƒˆ** ğŸ§ª",
        embeds: [{
          title: "ç·¨é›†ãƒãƒ¼ãƒ å‘ã‘Webhookã®ãƒ†ã‚¹ãƒˆ",
          description: "ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã€Webhook URLãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã®ãƒ†ã‚¹ãƒˆã§ã™ã€‚",
          color: 5814783, // é’è‰²
          timestamp: new Date().toISOString()
        }]
      };
      
      const options = {
        method: "post",
        contentType: "application/json",
        payload: JSON.stringify(message),
        muteHttpExceptions: true
      };
      
      const response = UrlFetchApp.fetch(editorsWebhook, options);
      const code = response.getResponseCode();
      
      if (code === 204) {
        results += "âœ… ç·¨é›†ãƒãƒ¼ãƒ å‘ã‘Webhook: æ­£å¸¸ã«é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸ\n\n";
      } else {
        results += `âŒ ç·¨é›†ãƒãƒ¼ãƒ å‘ã‘Webhook: ã‚¨ãƒ©ãƒ¼ (HTTP ${code})\n\n`;
      }
    } catch (error) {
      results += `âŒ ç·¨é›†ãƒãƒ¼ãƒ å‘ã‘Webhook: ${error.message}\n\n`;
    }
  } else {
    results += "âš ï¸ ç·¨é›†ãƒãƒ¼ãƒ å‘ã‘Webhook: URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“\n\n";
  }
  
  // å—è¬›è€…å‘ã‘Webhookã®ãƒ†ã‚¹ãƒˆ
  if (studentsWebhook) {
    try {
      const message = {
        content: "ğŸ§ª **Webhook ãƒ†ã‚¹ãƒˆ** ğŸ§ª",
        embeds: [{
          title: "å—è¬›è€…å‘ã‘Webhookã®ãƒ†ã‚¹ãƒˆ",
          description: "ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã€Webhook URLãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã®ãƒ†ã‚¹ãƒˆã§ã™ã€‚",
          color: 16711680, // èµ¤è‰²
          timestamp: new Date().toISOString()
        }]
      };
      
      const options = {
        method: "post",
        contentType: "application/json",
        payload: JSON.stringify(message),
        muteHttpExceptions: true
      };
      
      const response = UrlFetchApp.fetch(studentsWebhook, options);
      const code = response.getResponseCode();
      
      if (code === 204) {
        results += "âœ… å—è¬›è€…å‘ã‘Webhook: æ­£å¸¸ã«é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸ";
      } else {
        results += `âŒ å—è¬›è€…å‘ã‘Webhook: ã‚¨ãƒ©ãƒ¼ (HTTP ${code})`;
      }
    } catch (error) {
      results += `âŒ å—è¬›è€…å‘ã‘Webhook: ${error.message}`;
    }
  } else {
    results += "âš ï¸ å—è¬›è€…å‘ã‘Webhook: URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“";
  }
  
  return results;
}

/**
 * ãƒ˜ãƒ«ãƒ—ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
 */
function showHelpDialog() {
  const html = HtmlService.createHtmlOutput(`
    <style>
      body { font-family: Arial, sans-serif; margin: 20px; }
      h3 { color: #4285f4; }
      li { margin-bottom: 10px; }
    </style>
    <h2>ZooméŒ²ç”»è‡ªå‹•å‡¦ç†ã‚·ã‚¹ãƒ†ãƒ  - ãƒ˜ãƒ«ãƒ—</h2>
    <h3>åŸºæœ¬çš„ãªä½¿ã„æ–¹</h3>
    <ol>
      <li>Zoomä¼šè­°ãŒçµ‚äº†ã™ã‚‹ã¨ã€ã€ŒéŒ²ç”»ã€ã‚¿ã‚°ä»˜ããƒ¡ãƒ¼ãƒ«ãŒå±Šãã¾ã™</li>
      <li>ã‚·ã‚¹ãƒ†ãƒ ã¯15åˆ†ã”ã¨ã«è‡ªå‹•çš„ã«ãƒ¡ãƒ¼ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™</li>
      <li>éŒ²ç”»æƒ…å ±ãŒã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è¿½åŠ ã•ã‚Œã€Discordã«é€šçŸ¥ã•ã‚Œã¾ã™</li>
      <li>ç·¨é›†è€…ã¯éŒ²ç”»ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã€YouTubeã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™</li>
      <li>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¾Œã€ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å—è¬›è€…ã«é€šçŸ¥ã—ã¾ã™</li>
    </ol>
    
    <h3>æ‰‹å‹•æ“ä½œ</h3>
    <ul>
      <li>ã€Œæ‰‹å‹•ã§ãƒ¡ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯ã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ä½¿ç”¨ã—ã¦å³æ™‚ãƒã‚§ãƒƒã‚¯ãŒã§ãã¾ã™</li>
      <li>ã€ŒYouTube URLã€ã¨ã€Œèª¬æ˜ã€ã‚’å…¥åŠ›ã—ã¦ã‹ã‚‰ã€ŒDiscordé€šçŸ¥ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„</li>
    </ul>
    
    <h3>ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°</h3>
    <ul>
      <li>éŒ²ç”»ãƒ¡ãƒ¼ãƒ«ãŒæ¤œå‡ºã•ã‚Œãªã„å ´åˆã€ã€ŒéŒ²ç”»ã€ã‚¿ã‚°ãŒæ­£ã—ãä»˜ã„ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„</li>
      <li>Discordé€šçŸ¥ãŒå±Šã‹ãªã„å ´åˆã€Webhook URLã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„</li>
    </ul>
  `)
  .setWidth(600)
  .setHeight(400);
  
  SpreadsheetApp.getUi().showModalDialog(html, 'ãƒ˜ãƒ«ãƒ—');
}

/**
 * ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®åˆæœŸåŒ–
 */
function initializeSpreadsheet() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  
  // éŒ²ç”»ç®¡ç†ã‚·ãƒ¼ãƒˆã®åˆæœŸåŒ–
  let recordingsSheet = ss.getSheetByName(SHEET_NAME_RECORDINGS);
  if (!recordingsSheet) {
    recordingsSheet = ss.insertSheet(SHEET_NAME_RECORDINGS);
    
    // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’è¨­å®š
    recordingsSheet.getRange("A1:I1").setValues([["æ—¥ä»˜", "ä¼šè­°å", "éŒ²ç”»æ™‚é–“", "å…±æœ‰URL", "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰", "YouTube URL", "YouTubeèª¬æ˜", "å‡¦ç†çŠ¶æ…‹", "é€šçŸ¥"]]);
    recordingsSheet.getRange("A1:I1").setFontWeight("bold");
    recordingsSheet.setFrozenRows(1);
    
    // åˆ—å¹…ã‚’èª¿æ•´
    recordingsSheet.setColumnWidth(1, 100); // æ—¥ä»˜
    recordingsSheet.setColumnWidth(2, 200); // ä¼šè­°å
    recordingsSheet.setColumnWidth(3, 80);  // éŒ²ç”»æ™‚é–“
    recordingsSheet.setColumnWidth(4, 300); // å…±æœ‰URL
    recordingsSheet.setColumnWidth(5, 100); // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
    recordingsSheet.setColumnWidth(6, 300); // YouTube URL
    recordingsSheet.setColumnWidth(7, 300); // YouTubeèª¬æ˜
    recordingsSheet.setColumnWidth(8, 100); // å‡¦ç†çŠ¶æ…‹
    recordingsSheet.setColumnWidth(9, 100); // é€šçŸ¥ãƒœã‚¿ãƒ³
    
    // ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’æŒ¿å…¥
    insertDummyData(recordingsSheet);
  }
  
  // è¨­å®šã‚·ãƒ¼ãƒˆã®åˆæœŸåŒ–
  let settingsSheet = ss.getSheetByName(SHEET_NAME_SETTINGS);
  if (!settingsSheet) {
    settingsSheet = ss.insertSheet(SHEET_NAME_SETTINGS);
    
    // è¨­å®šé …ç›®ã‚’è¿½åŠ 
    settingsSheet.getRange("A1:B1").setValues([["è¨­å®šé …ç›®", "å€¤"]]);
    settingsSheet.getRange("A1:B1").setFontWeight("bold");
    settingsSheet.getRange("A2").setValue("ç·¨é›†ãƒãƒ¼ãƒ å‘ã‘Discord webhook URL");
    settingsSheet.getRange("A3").setValue("å—è¬›è€…å‘ã‘Discord webhook URL");
    settingsSheet.getRange("A4").setValue("Webhookç¢ºèªé–“éš”ï¼ˆæ™‚é–“ï¼‰");
    settingsSheet.getRange("B4").setValue("12");
    settingsSheet.getRange("A5").setValue("æœ€çµ‚Webhookç¢ºèªæ—¥æ™‚");
    settingsSheet.getRange("B5").setValue(new Date());
    
    // åˆ—å¹…ã‚’èª¿æ•´
    settingsSheet.setColumnWidth(1, 300);
    settingsSheet.setColumnWidth(2, 500);
    
    // ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‹ã‚‰å€¤ã‚’è¨­å®š
    settingsSheet.getRange("B2").setValue(PROPERTIES.getProperty('DISCORD_WEBHOOK_EDITORS') || '');
    settingsSheet.getRange("B3").setValue(PROPERTIES.getProperty('DISCORD_WEBHOOK_STUDENTS') || '');
  }
  
  // é€šçŸ¥ãƒœã‚¿ãƒ³ã‚’è¿½åŠ ã™ã‚‹ã‚ªãƒ³ã‚¨ãƒ‡ã‚£ãƒƒãƒˆãƒˆãƒªã‚¬ãƒ¼ã‚’è¨­å®š
  setOnEditTriggerIfNeeded();
  
  // Webhookç¢ºèªãƒˆãƒªã‚¬ãƒ¼ã‚’è¨­å®š
  setWebhookCheckTriggerIfNeeded();
}

/**
 * ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«æŒ¿å…¥
 */
function insertDummyData(sheet) {
  // ç¾åœ¨æ—¥æ™‚ã‹ã‚‰éå»ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
  const now = new Date();
  
  // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿
  const dummyData = [
    // 1é€±é–“å‰ã®ãƒ‡ãƒ¼ã‚¿ - é€šçŸ¥æ¸ˆã¿
    {
      date: new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000),
      meetingName: "ã‚¦ã‚§ãƒ–é–‹ç™ºå…¥é–€è¬›åº§ #1",
      duration: "01:15:30",
      url: "https://us06web.zoom.us/rec/share/sample-url-for-lesson1",
      password: "Abc123",
      youtubeUrl: "https://youtu.be/sample-youtube-url-1",
      description: "ã€ã‚¦ã‚§ãƒ–é–‹ç™ºå…¥é–€ã€‘HTML/CSSã®åŸºç¤ã«ã¤ã„ã¦å­¦ç¿’ã—ã¾ã™ã€‚åˆå›ã¯ã‚¦ã‚§ãƒ–ã®ä»•çµ„ã¿ã¨HTMLã®åŸºæœ¬æ§‹é€ ã‚’è§£èª¬ã—ã¦ã„ã¾ã™ã€‚",
      status: "é€šçŸ¥æ¸ˆã¿",
      notification: "âœ“ å®Œäº†"
    },
    // 3æ—¥å‰ã®ãƒ‡ãƒ¼ã‚¿ - ç·¨é›†æ¸ˆã¿
    {
      date: new Date(now.getTime() - 3 * 24 * 60 * 60 * 1000),
      meetingName: "ã‚¦ã‚§ãƒ–é–‹ç™ºå…¥é–€è¬›åº§ #2",
      duration: "01:23:45",
      url: "https://us06web.zoom.us/rec/share/sample-url-for-lesson2",
      password: "Def456",
      youtubeUrl: "https://youtu.be/sample-youtube-url-2",
      description: "ã€ã‚¦ã‚§ãƒ–é–‹ç™ºå…¥é–€ã€‘CSSã‚’ä½¿ã£ãŸã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°ã®åŸºæœ¬ã¨ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ã«ã¤ã„ã¦è§£èª¬ã—ã¦ã„ã¾ã™ã€‚",
      status: "ç·¨é›†æ¸ˆã¿",
      notification: "Discordã«é€šçŸ¥"
    },
    // 1æ—¥å‰ã®ãƒ‡ãƒ¼ã‚¿ - æœªå‡¦ç†
    {
      date: new Date(now.getTime() - 1 * 24 * 60 * 60 * 1000),
      meetingName: "ã‚¦ã‚§ãƒ–é–‹ç™ºå…¥é–€è¬›åº§ #3",
      duration: "01:30:00",
      url: "https://us06web.zoom.us/rec/share/sample-url-for-lesson3",
      password: "Ghi789",
      youtubeUrl: "",
      description: "",
      status: "æœªå‡¦ç†",
      notification: ""
    }
  ];
  
  // ãƒ‡ãƒ¼ã‚¿ã‚’æŒ¿å…¥
  for (let i = 0; i < dummyData.length; i++) {
    const data = dummyData[i];
    const row = i + 2; // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã®æ¬¡ã‹ã‚‰
    
    sheet.getRange(row, 1).setValue(data.date);
    sheet.getRange(row, 2).setValue(data.meetingName);
    sheet.getRange(row, 3).setValue(data.duration);
    
    // URLã‚’ãƒã‚¤ãƒ‘ãƒ¼ãƒªãƒ³ã‚¯ã¨ã—ã¦è¨­å®š
    if (data.url) {
      sheet.getRange(row, 4).setFormula(`=HYPERLINK("${data.url}", "${data.url}")`);
    } else {
      sheet.getRange(row, 4).setValue(data.url);
    }
    
    sheet.getRange(row, 5).setValue(data.password);
    
    // YouTube URLã‚’ãƒã‚¤ãƒ‘ãƒ¼ãƒªãƒ³ã‚¯ã¨ã—ã¦è¨­å®š
    if (data.youtubeUrl) {
      sheet.getRange(row, 6).setFormula(`=HYPERLINK("${data.youtubeUrl}", "${data.youtubeUrl}")`);
    } else {
      sheet.getRange(row, 6).setValue(data.youtubeUrl);
    }
    
    sheet.getRange(row, 7).setValue(data.description);
    sheet.getRange(row, 8).setValue(data.status);
    
    // é€šçŸ¥ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°
    sheet.getRange(row, 9).setValue(data.notification);
    
    if (data.notification === "Discordã«é€šçŸ¥") {
      sheet.getRange(row, 9)
        .setFontColor("blue")
        .setFontWeight("bold")
        .setHorizontalAlignment("center")
        .setBackground("#e6f2ff");
    } else if (data.notification === "âœ“ å®Œäº†") {
      sheet.getRange(row, 9)
        .setFontColor("green")
        .setFontWeight("bold")
        .setHorizontalAlignment("center");
    }
  }
}

/**
 * å®šæœŸå®Ÿè¡Œãƒˆãƒªã‚¬ãƒ¼ã®è¨­å®šï¼ˆ15åˆ†ã”ã¨ï¼‰
 */
function setTriggerIfNeeded() {
  const triggers = ScriptApp.getProjectTriggers();
  let exists = false;
  
  // æ—¢å­˜ã®ãƒˆãƒªã‚¬ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯
  for (const trigger of triggers) {
    if (trigger.getHandlerFunction() === 'checkZoomEmails') {
      exists = true;
      break;
    }
  }
  
  // ãƒˆãƒªã‚¬ãƒ¼ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
  if (!exists) {
    ScriptApp.newTrigger('checkZoomEmails')
      .timeBased()
      .everyMinutes(15)
      .create();
  }
}

/**
 * Webhookç¢ºèªãƒˆãƒªã‚¬ãƒ¼ã®è¨­å®šï¼ˆ12æ™‚é–“ã”ã¨ï¼‰
 */
function setWebhookCheckTriggerIfNeeded() {
  const triggers = ScriptApp.getProjectTriggers();
  let exists = false;
  
  // æ—¢å­˜ã®ãƒˆãƒªã‚¬ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯
  for (const trigger of triggers) {
    if (trigger.getHandlerFunction() === 'checkWebhookStatus') {
      exists = true;
      break;
    }
  }
  
  // ãƒˆãƒªã‚¬ãƒ¼ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
  if (!exists) {
    ScriptApp.newTrigger('checkWebhookStatus')
      .timeBased()
      .everyHours(12)
      .create();
  }
}

/**
 * Discord Webhookã®çŠ¶æ…‹ã‚’ç¢ºèªã™ã‚‹
 * 12æ™‚é–“ã”ã¨ã«å®Ÿè¡Œã•ã‚Œã€WebhookãŒæœ‰åŠ¹ã‹ã©ã†ã‹ã‚’ç¢ºèª
 */
function checkWebhookStatus() {
  try {
    // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰è¨­å®šã‚’å–å¾—
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const settingsSheet = ss.getSheetByName(SHEET_NAME_SETTINGS);
    
    // ç¢ºèªé–“éš”ï¼ˆæ™‚é–“ï¼‰ã‚’å–å¾—
    const checkInterval = Number(settingsSheet.getRange("B4").getValue()) || 12;
    
    // å‰å›ã®ç¢ºèªæ—¥æ™‚ã‚’å–å¾—
    const lastChecked = new Date(settingsSheet.getRange("B5").getValue());
    const now = new Date();
    
    // å‰å›ã®ç¢ºèªã‹ã‚‰æŒ‡å®šæ™‚é–“ãŒçµŒéã—ã¦ã„ãªã‘ã‚Œã°ã‚¹ã‚­ãƒƒãƒ—
    const hoursSinceLastCheck = (now - lastChecked) / (1000 * 60 * 60);
    if (hoursSinceLastCheck < checkInterval) {
      console.log(`å‰å›ã®ç¢ºèªã‹ã‚‰${hoursSinceLastCheck}æ™‚é–“ã—ã‹çµŒéã—ã¦ã„ãªã„ãŸã‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ (ç¢ºèªé–“éš”: ${checkInterval}æ™‚é–“)`);
      return;
    }
    
    // Webhookã®çŠ¶æ…‹ã‚’ç¢ºèª
    const editorsWebhook = PROPERTIES.getProperty('DISCORD_WEBHOOK_EDITORS');
    const studentsWebhook = PROPERTIES.getProperty('DISCORD_WEBHOOK_STUDENTS');
    
    let editorsStatus = "æœªè¨­å®š";
    let studentsStatus = "æœªè¨­å®š";
    
    // ç·¨é›†ãƒãƒ¼ãƒ å‘ã‘Webhookã®ç¢ºèª
    if (editorsWebhook) {
      try {
        const response = UrlFetchApp.fetch(editorsWebhook, { method: "get", muteHttpExceptions: true });
        editorsStatus = (response.getResponseCode() === 200) ? "æœ‰åŠ¹" : "ç„¡åŠ¹";
      } catch (e) {
        editorsStatus = "ã‚¨ãƒ©ãƒ¼: " + e.message;
      }
    }
    
    // å—è¬›è€…å‘ã‘Webhookã®ç¢ºèª
    if (studentsWebhook) {
      try {
        const response = UrlFetchApp.fetch(studentsWebhook, { method: "get", muteHttpExceptions: true });
        studentsStatus = (response.getResponseCode() === 200) ? "æœ‰åŠ¹" : "ç„¡åŠ¹";
      } catch (e) {
        studentsStatus = "ã‚¨ãƒ©ãƒ¼: " + e.message;
      }
    }
    
    // ãƒ­ã‚°ã«è¨˜éŒ²
    console.log(`Webhookç¢ºèªçµæœ - ç·¨é›†ãƒãƒ¼ãƒ : ${editorsStatus}, å—è¬›è€…: ${studentsStatus}`);
    
    // çµæœã‚’ã‚·ãƒ¼ãƒˆã«è¨˜éŒ²
    settingsSheet.getRange("A6").setValue("ç·¨é›†ãƒãƒ¼ãƒ å‘ã‘WebhookçŠ¶æ…‹");
    settingsSheet.getRange("B6").setValue(editorsStatus);
    settingsSheet.getRange("A7").setValue("å—è¬›è€…å‘ã‘WebhookçŠ¶æ…‹");
    settingsSheet.getRange("B7").setValue(studentsStatus);
    
    // æœ€çµ‚ç¢ºèªæ—¥æ™‚ã‚’æ›´æ–°
    settingsSheet.getRange("B5").setValue(now);
    
    // ã„ãšã‚Œã‹ã®WebhookãŒæœ‰åŠ¹ã§ãªã„å ´åˆã¯ç®¡ç†è€…ã«é€šçŸ¥ï¼ˆãƒ¡ãƒ¼ãƒ«é€ä¿¡ãªã©ï¼‰
    if (editorsStatus !== "æœ‰åŠ¹" || studentsStatus !== "æœ‰åŠ¹") {
      sendWebhookAlert(editorsStatus, studentsStatus);
    }
  } catch (error) {
    console.error(`Webhookç¢ºèªä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
  }
}

/**
 * Webhookã«å•é¡ŒãŒã‚ã‚‹å ´åˆã®ã‚¢ãƒ©ãƒ¼ãƒˆé€ä¿¡
 */
function sendWebhookAlert(editorsStatus, studentsStatus) {
  try {
    // ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—
    const email = Session.getActiveUser().getEmail();
    
    // ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ã‚’ä½œæˆ
    const subject = "[è­¦å‘Š] Discord Webhookã«å•é¡ŒãŒã‚ã‚Šã¾ã™";
    const body = `
      ZooméŒ²ç”»è‡ªå‹•å‡¦ç†ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰ã®é€šçŸ¥ã§ã™ã€‚
      
      Discord Webhookã®çŠ¶æ…‹ç¢ºèªã‚’è¡Œã£ãŸã¨ã“ã‚ã€å•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚
      
      - ç·¨é›†ãƒãƒ¼ãƒ å‘ã‘Webhook: ${editorsStatus}
      - å—è¬›è€…å‘ã‘Webhook: ${studentsStatus}
      
      ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ã€Œã‚·ã‚¹ãƒ†ãƒ è¨­å®šã€ã‹ã‚‰è¨­å®šã‚’ç¢ºèªã—ã€å¿…è¦ã«å¿œã˜ã¦æ›´æ–°ã—ã¦ãã ã•ã„ã€‚
      
      ã“ã®ãƒ¡ãƒ¼ãƒ«ã¯è‡ªå‹•é€ä¿¡ã•ã‚Œã¦ã„ã¾ã™ã€‚
    `;
    
    // ãƒ¡ãƒ¼ãƒ«é€ä¿¡
    MailApp.sendEmail(email, subject, body);
    console.log(`è­¦å‘Šãƒ¡ãƒ¼ãƒ«ã‚’ ${email} ã«é€ä¿¡ã—ã¾ã—ãŸ`);
  } catch (error) {
    console.error(`ã‚¢ãƒ©ãƒ¼ãƒˆãƒ¡ãƒ¼ãƒ«é€ä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
  }
}

/**
 * onEditãƒˆãƒªã‚¬ãƒ¼ã®è¨­å®š
 */
function setOnEditTriggerIfNeeded() {
  const triggers = ScriptApp.getProjectTriggers();
  let exists = false;
  
  // æ—¢å­˜ã®ãƒˆãƒªã‚¬ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯
  for (const trigger of triggers) {
    if (trigger.getHandlerFunction() === 'onEdit') {
      exists = true;
      break;
    }
  }
  
  // ãƒˆãƒªã‚¬ãƒ¼ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
  if (!exists) {
    ScriptApp.newTrigger('onEdit')
      .forSpreadsheet(SpreadsheetApp.getActiveSpreadsheet())
      .onEdit()
      .create();
  }
}

/**
 * ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆç·¨é›†æ™‚ã®å‡¦ç†
 */
function onEdit(e) {
  const range = e.range;
  const sheet = range.getSheet();
  
  // éŒ²ç”»ç®¡ç†ã‚·ãƒ¼ãƒˆã®å ´åˆã®ã¿å‡¦ç†
  if (sheet.getName() !== SHEET_NAME_RECORDINGS) return;
  
  // Håˆ—ï¼ˆå‡¦ç†çŠ¶æ…‹ï¼‰ãŒã€Œç·¨é›†æ¸ˆã¿ã€ã«å¤‰æ›´ã•ã‚ŒãŸå ´åˆã€é€šçŸ¥ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
  if (range.getColumn() === 8 && range.getValue() === "ç·¨é›†æ¸ˆã¿") {
    const row = range.getRow();
    
    // é€šçŸ¥ãƒœã‚¿ãƒ³ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    const notifyCell = sheet.getRange(row, 9);
    notifyCell.setValue("Discordã«é€šçŸ¥");
    notifyCell.setFontColor("blue");
    notifyCell.setFontWeight("bold");
    notifyCell.setHorizontalAlignment("center");
    
    // ã‚»ãƒ«ã®èƒŒæ™¯è‰²ã‚’è¨­å®š
    notifyCell.setBackground("#e6f2ff");
  }
}

/**
 * ãƒˆãƒªã‚¬ãƒ¼è¨­å®šç”¨ã®å°‚ç”¨é–¢æ•°
 */
function setupTriggers() {
  const ui = SpreadsheetApp.getUi();
  const result = ui.alert(
    'ãƒˆãƒªã‚¬ãƒ¼è¨­å®š',
    'ä»¥ä¸‹ã®ãƒˆãƒªã‚¬ãƒ¼ã‚’è¨­å®šã—ã¾ã™ï¼š\n\n' +
    'ãƒ»15åˆ†ã”ã¨ã®ãƒ¡ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯\n' +
    'ãƒ»12æ™‚é–“ã”ã¨ã®Webhookç¢ºèª\n\n' +
    'æ—¢å­˜ã®ãƒˆãƒªã‚¬ãƒ¼ã¯å‰Šé™¤ã•ã‚Œã¾ã™ã€‚ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ',
    ui.ButtonSet.YES_NO
  );
  
  if (result === ui.Button.YES) {
    // æ—¢å­˜ã®ãƒˆãƒªã‚¬ãƒ¼ã‚’ã™ã¹ã¦å‰Šé™¤
    const triggers = ScriptApp.getProjectTriggers();
    for (const trigger of triggers) {
      ScriptApp.deleteTrigger(trigger);
    }
    
    // ãƒ¡ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯ãƒˆãƒªã‚¬ãƒ¼ã‚’è¨­å®š
    ScriptApp.newTrigger('checkZoomEmails')
      .timeBased()
      .everyMinutes(15)
      .create();
    
    // Webhookç¢ºèªãƒˆãƒªã‚¬ãƒ¼ã‚’è¨­å®š
    ScriptApp.newTrigger('checkWebhookStatus')
      .timeBased()
      .everyHours(12)
      .create();
    
    ui.alert('ãƒˆãƒªã‚¬ãƒ¼è¨­å®š', 'ãƒˆãƒªã‚¬ãƒ¼ã®è¨­å®šãŒå®Œäº†ã—ã¾ã—ãŸã€‚', ui.ButtonSet.OK);
  }
}

/**
 * æ‰‹å‹•ã§å—è¬›ç”Ÿã«é€šçŸ¥ã™ã‚‹é–¢æ•°
 */
function manuallyNotifyStudents() {
  const ui = SpreadsheetApp.getUi();
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(SHEET_NAME_RECORDINGS);
  
  if (!sheet) {
    ui.alert('ã‚¨ãƒ©ãƒ¼', 'éŒ²ç”»ç®¡ç†ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', ui.ButtonSet.OK);
    return;
  }
  
  const activeRow = sheet.getActiveCell().getRow();
  if (activeRow <= 1) {
    ui.alert('ã‚¨ãƒ©ãƒ¼', 'é€šçŸ¥ã—ãŸã„éŒ²ç”»ã®è¡Œã‚’é¸æŠã—ã¦ã‹ã‚‰å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚', ui.ButtonSet.OK);
    return;
  }
  
  // é¸æŠã•ã‚ŒãŸè¡Œã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
  const meetingName = sheet.getRange(activeRow, 2).getValue();
  const youtubeUrl = sheet.getRange(activeRow, 6).getValue();
  const description = sheet.getRange(activeRow, 7).getValue();
  
  if (!youtubeUrl) {
    ui.alert('ã‚¨ãƒ©ãƒ¼', 'YouTube URLãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚', ui.ButtonSet.OK);
    return;
  }
  
  // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
  const confirmResult = ui.alert(
    'ç¢ºèª',
    `ä»¥ä¸‹ã®å†…å®¹ã§å—è¬›ç”Ÿã«é€šçŸ¥ã—ã¾ã™ã‹ï¼Ÿ\n\n` +
    `ã‚¿ã‚¤ãƒˆãƒ«: ${meetingName}\n` +
    `YouTube: ${youtubeUrl}\n` +
    `èª¬æ˜: ${description}\n`,
    ui.ButtonSet.YES_NO
  );
  
  if (confirmResult === ui.Button.YES) {
    try {
      // Discordé€šçŸ¥ã‚’é€ä¿¡
      notifyStudentsDiscord(meetingName, youtubeUrl, description);
      
      // å‡¦ç†çŠ¶æ…‹ã‚’æ›´æ–°
      sheet.getRange(activeRow, 8).setValue("é€šçŸ¥æ¸ˆã¿");
      sheet.getRange(activeRow, 9).setValue("âœ“ å®Œäº†").setFontColor("green");
      
      ui.alert('æˆåŠŸ', 'Discordé€šçŸ¥ãŒæ­£å¸¸ã«é€ä¿¡ã•ã‚Œã¾ã—ãŸã€‚', ui.ButtonSet.OK);
    } catch (error) {
      ui.alert('ã‚¨ãƒ©ãƒ¼', `é€šçŸ¥ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`, ui.ButtonSet.OK);
    }
  }
}

/**
 * Zoomã®éŒ²ç”»ãƒ¡ãƒ¼ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆå®šæœŸå®Ÿè¡ŒãŠã‚ˆã³æ‰‹å‹•å®Ÿè¡Œç”¨ï¼‰
 */
function checkZoomEmails() {
  try {
    // ãƒ¡ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯ã®å‰ã«ã€å¿…è¦ãªã‚¿ã‚°ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèªã—ã€ãªã‘ã‚Œã°ä½œæˆ
    ensureGmailLabelsExist();
    
    // ã€ŒéŒ²ç”»ã€ã‚¿ã‚°ä»˜ããƒ¡ãƒ¼ãƒ«ã‚’æ¤œç´¢
    const query = `label:${TAG_RECORDING} from:no-reply@zoom.us subject:"ã‚¯ãƒ©ã‚¦ãƒ‰ ãƒ¬ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°"`;
    const threads = GmailApp.search(query, 0, 10); // æœ€æ–°10ä»¶ã¾ã§å‡¦ç†
    
    // æ‰‹å‹•å®Ÿè¡Œã®å ´åˆã€çµæœã‚’è¡¨ç¤º
    const isManualRun = ScriptApp.getScriptId() === ScriptApp.getActiveId();
    if (isManualRun && threads.length === 0) {
      SpreadsheetApp.getUi().alert('ãƒ¡ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯', 'æ–°ã—ã„éŒ²ç”»ãƒ¡ãƒ¼ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚', SpreadsheetApp.getUi().ButtonSet.OK);
      return;
    }
    
    console.log(`${threads.length}ä»¶ã®éŒ²ç”»ãƒ¡ãƒ¼ãƒ«ã‚’å‡¦ç†ã—ã¾ã™`);
    let processedCount = 0;
    
    for (const thread of threads) {
      const messages = thread.getMessages();
      
      for (const message of messages) {
        // å‡¦ç†æ¸ˆã¿ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆã‚¿ã‚°ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ï¼‰
        if (isMessageProcessed(message)) continue;
        
        // ãƒ¡ãƒ¼ãƒ«ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
        const recordingData = extractRecordingData(message);
        
        if (recordingData) {
          // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«æƒ…å ±ã‚’è¨˜éŒ²
          addRecordingToSheet(recordingData);
          
          // Discordé€šçŸ¥ã‚’é€ä¿¡
          notifyEditorsDiscord(recordingData);
          
          // ãƒ¡ãƒ¼ãƒ«ã®ã‚¿ã‚°ã‚’å¤‰æ›´
          changeMessageTag(message);
          
          processedCount++;
          console.log(`ãƒ¡ãƒ¼ãƒ«ID: ${message.getId()} ã®å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸ`);
        } else {
          console.log(`ãƒ¡ãƒ¼ãƒ«ID: ${message.getId()} ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡ºã§ãã¾ã›ã‚“ã§ã—ãŸ`);
        }
      }
    }
    
    // æ‰‹å‹•å®Ÿè¡Œã®å ´åˆã€çµæœã‚’è¡¨ç¤º
    if (isManualRun) {
      SpreadsheetApp.getUi().alert(
        'ãƒ¡ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯', 
        `${processedCount}ä»¶ã®æ–°ã—ã„éŒ²ç”»ãƒ¡ãƒ¼ãƒ«ã‚’å‡¦ç†ã—ã¾ã—ãŸã€‚`, 
        SpreadsheetApp.getUi().ButtonSet.OK
      );
    }
  } catch (error) {
    console.error(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
    
    // æ‰‹å‹•å®Ÿè¡Œã®å ´åˆã€ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤º
    if (ScriptApp.getScriptId() === ScriptApp.getActiveId()) {
      SpreadsheetApp.getUi().alert('ã‚¨ãƒ©ãƒ¼', `ãƒ¡ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`, SpreadsheetApp.getUi().ButtonSet.OK);
    }
  }
}

/**
 * Gmailã®ãƒ©ãƒ™ãƒ«ï¼ˆã‚¿ã‚°ï¼‰ãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã€ãªã‘ã‚Œã°ä½œæˆ
 */
function ensureGmailLabelsExist() {
  // ã€ŒéŒ²ç”»ã€ã‚¿ã‚°ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
  let recordingLabel = GmailApp.getUserLabelByName(TAG_RECORDING);
  if (!recordingLabel) {
    recordingLabel = GmailApp.createLabel(TAG_RECORDING);
    console.log(`ã€Œ${TAG_RECORDING}ã€ã‚¿ã‚°ã‚’ä½œæˆã—ã¾ã—ãŸ`);
  }
  
  // ã€ŒéŒ²ç”»å‡¦ç†æ¸ˆã¿ã€ã‚¿ã‚°ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
  let processedLabel = GmailApp.getUserLabelByName(TAG_PROCESSED);
  if (!processedLabel) {
    processedLabel = GmailApp.createLabel(TAG_PROCESSED);
    console.log(`ã€Œ${TAG_PROCESSED}ã€ã‚¿ã‚°ã‚’ä½œæˆã—ã¾ã—ãŸ`);
  }
  
  return { recordingLabel, processedLabel };
}

/**
 * Zoomã‹ã‚‰ã®ãƒ¡ãƒ¼ãƒ«ã‚’è‡ªå‹•çš„ã«æŒ¯ã‚Šåˆ†ã‘ã‚‹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’è¨­å®šã™ã‚‹ãŸã‚ã®èª¬æ˜ã‚’è¡¨ç¤º
 */
function setupZoomEmailFilter() {
  const ui = SpreadsheetApp.getUi();
  
  const result = ui.alert(
    'ãƒ¡ãƒ¼ãƒ«ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¨­å®š',
    'Zoomã‹ã‚‰ã®ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¬ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒ¼ãƒ«ã‚’ã€ŒéŒ²ç”»ã€ã‚¿ã‚°ã«è‡ªå‹•æŒ¯ã‚Šåˆ†ã‘ã™ã‚‹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’è¨­å®šã—ã¾ã™ã‹ï¼Ÿ\n\n' +
    'ã“ã‚Œã¯Gmailã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½ã‚’ä½¿ã£ã¦æ‰‹å‹•ã§è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚æ‰‹é †ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚',
    ui.ButtonSet.YES_NO
  );
  
  if (result === ui.Button.YES) {
    const instructions = HtmlService.createHtmlOutput(`
      <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        h3 { color: #4285f4; }
        ol { margin-left: 20px; }
        li { margin-bottom: 10px; }
        .note { background-color: #f8f9fa; padding: 10px; border-left: 4px solid #4285f4; margin: 15px 0; }
      </style>
      <h2>Gmailãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¨­å®šæ‰‹é †</h2>
      
      <ol>
        <li>Gmailã‚’é–‹ãã¾ã™</li>
        <li>æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ã«ã€Œfrom:no-reply@zoom.us subject:ã‚¯ãƒ©ã‚¦ãƒ‰ ãƒ¬ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã€ã¨å…¥åŠ›ã—ã¾ã™</li>
        <li>æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ã®å³å´ã«ã‚ã‚‹ã€Œæ¤œç´¢ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤ºã€ãƒœã‚¿ãƒ³ï¼ˆâ–¼ï¼‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™</li>
        <li>ã€Œæ¤œç´¢æ¼”ç®—å­ã«ä¸€è‡´ã™ã‚‹ãƒ¡ãƒ¼ãƒ«ã‚’æ¤œç´¢ã€ã®ä¸‹ã«ä¸Šè¨˜æ¡ä»¶ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™</li>
        <li>ã€Œãƒ•ã‚£ãƒ«ã‚¿ã‚’ä½œæˆã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™</li>
        <li>ã€Œãƒ©ãƒ™ãƒ«ã‚’ä»˜ã‘ã‚‹ã€ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã€ã€ŒéŒ²ç”»ã€ã‚’é¸æŠã—ã¾ã™ï¼ˆã¾ãŸã¯ã€Œæ–°ã—ã„ãƒ©ãƒ™ãƒ«ã€ã‹ã‚‰ä½œæˆï¼‰</li>
        <li>ã€Œãƒ•ã‚£ãƒ«ã‚¿ã‚’ä½œæˆã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å®Œäº†ã—ã¾ã™</li>
      </ol>
      
      <div class="note">
        <p><strong>æ³¨æ„:</strong> ã“ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã¯éå»ã®ãƒ¡ãƒ¼ãƒ«ã«ã¯é©ç”¨ã•ã‚Œã¾ã›ã‚“ã€‚éå»ã®ãƒ¡ãƒ¼ãƒ«ã«é©ç”¨ã—ãŸã„å ´åˆã¯ã€æ‰‹é †3ã®æ¤œç´¢çµæœç”»é¢ã§ã€Œã“ã®ãƒ•ã‚£ãƒ«ã‚¿ã«ä¸€è‡´ã™ã‚‹Xä»¶ã®ä¼šè©±ã«ã‚‚é©ç”¨ã™ã‚‹ã€ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚</p>
      </div>
    `)
    .setWidth(600)
    .setHeight(400);
    
    ui.showModalDialog(instructions, 'Gmailãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¨­å®šæ‰‹é †');
  }
}

/**
 * ãƒ¡ãƒ¼ãƒ«ãŒæ—¢ã«å‡¦ç†æ¸ˆã¿ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯
 */
function isMessageProcessed(message) {
  const subject = message.getSubject();
  const date = message.getDate();
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(SHEET_NAME_RECORDINGS);
  
  // å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
  const data = sheet.getDataRange().getValues();
  
  // æ—¥ä»˜ã¨ä»¶åãŒä¸€è‡´ã™ã‚‹ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
  for (let i = 1; i < data.length; i++) {
    const rowDate = data[i][0]; // æ—¥ä»˜åˆ—
    const rowName = data[i][1]; // ä¼šè­°ååˆ—
    
    if (rowDate && rowName && subject.includes(rowName)) {
      const timeDiff = Math.abs(rowDate - date) / (1000 * 60); // åˆ†å˜ä½ã®å·®
      if (timeDiff < 60) { // 1æ™‚é–“ä»¥å†…ã®å·®ã§ã‚ã‚Œã°åŒä¸€ã¨ã¿ãªã™
        return true;
      }
    }
  }
  
  return false;
}

/**
 * ãƒ¡ãƒ¼ãƒ«ã‹ã‚‰éŒ²ç”»æƒ…å ±ã‚’æŠ½å‡º
 */
function extractRecordingData(message) {
  const htmlBody = message.getBody();
  const subject = message.getSubject();
  const date = message.getDate();
  
  // ä¼šè­°åã‚’æŠ½å‡ºï¼ˆä»¶åã‹ã‚‰ã€Œã‚¯ãƒ©ã‚¦ãƒ‰ ãƒ¬ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° - ã€ã‚’é™¤å»ï¼‰
  const meetingName = subject.replace("ã‚¯ãƒ©ã‚¦ãƒ‰ ãƒ¬ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° - ", "").replace(" ãŒåˆ©ç”¨å¯èƒ½ã«ãªã‚Šã¾ã—ãŸ", "");
  
  // æ­£è¦è¡¨ç¾ã§URLã‚’æŠ½å‡º
  const urlMatch = htmlBody.match(/https:\/\/[^\s"<>]+zoom\.us\/rec\/share\/[^\s"<>]+/);
  const url = urlMatch ? urlMatch[0] : null;
  
  // æ­£è¦è¡¨ç¾ã§ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æŠ½å‡º
  const pwdMatch = htmlBody.match(/ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ï¼š\s*([A-Za-z0-9]+)/);
  const password = pwdMatch ? pwdMatch[1] : null;
  
  // éŒ²ç”»æ™‚é–“ã‚’æŠ½å‡º
  const durationMatch = htmlBody.match(/æ‰€è¦æ™‚é–“\s*(\d{2}:\d{2}:\d{2})/);
  const duration = durationMatch ? durationMatch[1] : null;
  
  if (!url || !password) {
    console.log("URLã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æŠ½å‡ºã§ãã¾ã›ã‚“ã§ã—ãŸ");
    return null;
  }
  
  return {
    date: date,
    meetingName: meetingName,
    duration: duration,
    url: url,
    password: password
  };
}

/**
 * addRecordingToSheeté–¢æ•° - ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«éŒ²ç”»æƒ…å ±ã‚’è¿½åŠ 
 */
function addRecordingToSheet(recordingData) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(SHEET_NAME_RECORDINGS);
  
  // æ¬¡ã®ç©ºãè¡Œã‚’è¦‹ã¤ã‘ã¦è¿½åŠ 
  const nextRow = sheet.getLastRow() + 1;
  
  // ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›
  sheet.getRange(nextRow, 1).setValue(recordingData.date);
  sheet.getRange(nextRow, 2).setValue(recordingData.meetingName);
  sheet.getRange(nextRow, 3).setValue(recordingData.duration);
  sheet.getRange(nextRow, 4).setValue(recordingData.url);
  sheet.getRange(nextRow, 5).setValue(recordingData.password);
  sheet.getRange(nextRow, 8).setValue("æœªå‡¦ç†");
  
  // è¡Œå…¨ä½“ã®æ›¸å¼ã‚’èª¿æ•´
  sheet.getRange(nextRow, 1, 1, 9).setHorizontalAlignment("left");
  sheet.getRange(nextRow, 1, 1, 9).setBorder(true, true, true, true, true, true);
  
  // URLã‚’ãƒã‚¤ãƒ‘ãƒ¼ãƒªãƒ³ã‚¯ã«è¨­å®š
  sheet.getRange(nextRow, 4).setFormula(`=HYPERLINK("${recordingData.url}", "${recordingData.url}")`);
}

/**
 * ç·¨é›†ãƒãƒ¼ãƒ å‘ã‘Discordé€šçŸ¥ã‚’é€ä¿¡
 */
function notifyEditorsDiscord(recordingData) {
  const webhookUrl = PROPERTIES.getProperty('DISCORD_WEBHOOK_EDITORS');
  if (!webhookUrl) {
    console.error("Discord Webhookã®URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“");
    return;
  }
  
  // çµµæ–‡å­—ã‚’å¤šç”¨ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  const message = {
    content: "ğŸ¬ **æ–°ã—ã„ZooméŒ²ç”»ãŒåˆ©ç”¨å¯èƒ½ã«ãªã‚Šã¾ã—ãŸï¼** ğŸ‰",
    embeds: [{
      title: `ğŸ“¹ ${recordingData.meetingName}`,
      color: 9442302, // ç´«è‰²
      fields: [
        {
          name: "ğŸ“… æ—¥æ™‚",
          value: Utilities.formatDate(recordingData.date, "Asia/Tokyo", "yyyy/MM/dd HH:mm"),
          inline: true
        },
        {
          name: "â±ï¸ éŒ²ç”»æ™‚é–“",
          value: recordingData.duration || "ä¸æ˜",
          inline: true
        },
        {
          name: "ğŸ”— å…±æœ‰ãƒªãƒ³ã‚¯",
          value: recordingData.url
        },
        {
          name: "ğŸ”‘ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰",
          value: `\`${recordingData.password}\``
        }
      ],
      footer: {
        text: "âœ¨ ç·¨é›†å¾Œã€ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®å‡¦ç†çŠ¶æ…‹ã‚’ã€Œç·¨é›†æ¸ˆã¿ã€ã«å¤‰æ›´ã—ã€Discordé€šçŸ¥ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ âœ¨"
      }
    }]
  };
  
  const options = {
    method: "post",
    contentType: "application/json",
    payload: JSON.stringify(message)
  };
  
  try {
    const response = UrlFetchApp.fetch(webhookUrl, options);
    console.log(`Discordé€šçŸ¥é€ä¿¡æˆåŠŸ: ${response.getResponseCode()}`);
  } catch (error) {
    console.error(`Discordé€šçŸ¥é€ä¿¡å¤±æ•—: ${error.message}`);
  }
}

/**
 * å‡¦ç†æ¸ˆã¿ãƒ¡ãƒ¼ãƒ«ã®ã‚¿ã‚°ã‚’å¤‰æ›´
 */
function changeMessageTag(message) {
  try {
    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’å–å¾—
    const thread = message.getThread();
    
    // ã‚¿ã‚°ã‚’å¤‰æ›´
    thread.removeLabel(GmailApp.getUserLabelByName(TAG_RECORDING));
    
    // å‡¦ç†æ¸ˆã¿ã‚¿ã‚°ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
    let processedLabel = GmailApp.getUserLabelByName(TAG_PROCESSED);
    if (!processedLabel) {
      processedLabel = GmailApp.createLabel(TAG_PROCESSED);
    }
    
    thread.addLabel(processedLabel);
    
    console.log(`ãƒ¡ãƒ¼ãƒ«ID: ${message.getId()} ã®ã‚¿ã‚°ã‚’ã€Œ${TAG_RECORDING}ã€ã‹ã‚‰ã€Œ${TAG_PROCESSED}ã€ã«å¤‰æ›´ã—ã¾ã—ãŸ`);
  } catch (error) {
    console.error(`ã‚¿ã‚°å¤‰æ›´ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
  }
}

/**
 * éŒ²ç”»å‡¦ç†æ¸ˆã¿ã®YouTubeå…¬é–‹Discordé€šçŸ¥
 * ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹
 */
function sendYouTubeNotification(row) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName(SHEET_NAME_RECORDINGS);
    
    // è¡Œãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    const meetingName = sheet.getRange(row, 2).getValue();
    const youtubeUrl = sheet.getRange(row, 6).getValue();
    const description = sheet.getRange(row, 7).getValue();
    
    if (!youtubeUrl) {
      throw new Error("YouTube URLãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“");
    }
    
    // Discordé€šçŸ¥ã‚’é€ä¿¡
    notifyStudentsDiscord(meetingName, youtubeUrl, description);
    
    // å‡¦ç†çŠ¶æ…‹ã‚’æ›´æ–°
    sheet.getRange(row, 8).setValue("é€šçŸ¥æ¸ˆã¿");
    sheet.getRange(row, 9).setValue("âœ“ å®Œäº†").setFontColor("green");
    
    // å‡¦ç†å±¥æ­´ã«è¨˜éŒ²
    logToHistory(
      meetingName,
      "YouTubeé€šçŸ¥",
      `URL: ${youtubeUrl}`
    );
    
    // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºï¼ˆæ‰‹å‹•å®Ÿè¡Œã®å ´åˆã®ã¿ï¼‰
    if (ScriptApp.getTriggerId() === null) {
      SpreadsheetApp.getUi().alert("Discordé€šçŸ¥ãŒæ­£å¸¸ã«é€ä¿¡ã•ã‚Œã¾ã—ãŸ");
    }
    
    return true;
  } catch (error) {
    console.error(`YouTubeé€šçŸ¥ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
    
    // å‡¦ç†å±¥æ­´ã«ã‚¨ãƒ©ãƒ¼ã‚’è¨˜éŒ²
    logToHistory(
      "YouTubeé€šçŸ¥",
      "ã‚¨ãƒ©ãƒ¼",
      error.message
    );
    
    // æ‰‹å‹•å®Ÿè¡Œã®å ´åˆã€ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤º
    if (ScriptApp.getTriggerId() === null) {
      SpreadsheetApp.getUi().alert(`ã‚¨ãƒ©ãƒ¼: ${error.message}`);
    }
    
    throw error;
  }
}

/**
 * å—è¬›è€…å‘ã‘Discordé€šçŸ¥ã‚’é€ä¿¡
 */
function notifyStudentsDiscord(meetingName, youtubeUrl, description) {
  const webhookUrl = PROPERTIES.getProperty('DISCORD_WEBHOOK_STUDENTS');
  if (!webhookUrl) {
    throw new Error("å—è¬›è€…å‘ã‘Discord Webhookã®URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“");
  }
  
  // çµµæ–‡å­—ã‚’å¤šç”¨ã—ãŸå—è¬›è€…å‘ã‘ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  const message = {
    content: "ğŸŒŸ **æ–°ã—ã„è¬›ç¾©å‹•ç”»ãŒå…¬é–‹ã•ã‚Œã¾ã—ãŸï¼** ğŸ“šâœ¨",
    embeds: [{
      title: `ğŸ“ ${meetingName}`,
      url: youtubeUrl,
      color: 16711680, // èµ¤è‰²
      description: description || "è¬›ç¾©ã®å‹•ç”»ãŒå…¬é–‹ã•ã‚Œã¾ã—ãŸã€‚ã”è¦–è´ãã ã•ã„ã€‚ğŸ’«",
      fields: [
        {
          name: "ğŸ“º YouTube URL",
          value: youtubeUrl
        }
      ],
      footer: {
        text: "â“ è³ªå•ãŒã‚ã‚‹å ´åˆã¯ã€ã‚³ãƒ¡ãƒ³ãƒˆæ¬„ã«ãŠé¡˜ã„ã—ã¾ã™ ğŸ“"
      }
    }]
  };
  
  const options = {
    method: "post",
    contentType: "application/json",
    payload: JSON.stringify(message)
  };
  
  try {
    const response = UrlFetchApp.fetch(webhookUrl, options);
    console.log(`Discordé€šçŸ¥é€ä¿¡æˆåŠŸ: ${response.getResponseCode()}`);
    return true;
  } catch (error) {
    console.error(`Discordé€šçŸ¥é€ä¿¡å¤±æ•—: ${error.message}`);
    throw error;
  }
}

/**
 * ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆç·¨é›†æ™‚ã®å‡¦ç†ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒãƒ³ãƒ‰ãƒ©ï¼‰
 */
function onEdit(e) {
  try {
    // é€šçŸ¥ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸå ´åˆã®å‡¦ç†
    if (e.range.getColumn() === 9 && e.range.getValue() === "Discordã«é€šçŸ¥") {
      sendYouTubeNotification(e.range.getRow());
    }
    
    // å‡¦ç†çŠ¶æ…‹ãŒã€Œç·¨é›†æ¸ˆã¿ã€ã«å¤‰æ›´ã•ã‚ŒãŸå ´åˆã€é€šçŸ¥ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
    if (e.range.getColumn() === 8 && e.range.getValue() === "ç·¨é›†æ¸ˆã¿") {
      const sheet = e.source.getActiveSheet();
      if (sheet.getName() === SHEET_NAME_RECORDINGS) {
        const row = e.range.getRow();
        
        // é€šçŸ¥ãƒœã‚¿ãƒ³ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        sheet.getRange(row, 9).setValue("Discordã«é€šçŸ¥")
          .setFontColor("blue")
          .setFontWeight("bold")
          .setHorizontalAlignment("center")
          .setBackground("#e6f2ff");
      }
    }
  } catch (error) {
    console.error(`onEditå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
  }
}

---

